<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - Hern√°ndezStore</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
            position: relative;
        }

        .connection-status {
            position: absolute;
            top: 15px;
            left: 20px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            color: white;
        }

        .connection-status.connected {
            background: #28a745;
        }

        .connection-status.disconnected {
            background: #dc3545;
        }

        .connection-status.loading {
            background: #ffc107;
            color: #333;
        }

        .store-link {
            position: absolute;
            top: 15px;
            right: 20px;
            background: #007bff;
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            transition: background 0.3s;
        }

        .store-link:hover {
            background: #0056b3;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .nav-tab {
            flex: 1;
            background: none;
            border: none;
            padding: 15px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }

        .nav-tab:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .nav-tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            padding: 25px;
            border-radius: 12px;
            color: white;
            text-align: center;
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .stat-card.products { background: linear-gradient(45deg, #28a745, #20c997); }
        .stat-card.categories { background: linear-gradient(45deg, #17a2b8, #20c997); }
        .stat-card.low-stock { background: linear-gradient(45deg, #ffc107, #fd7e14); }
        .stat-card.total-value { background: linear-gradient(45deg, #6f42c1, #e83e8c); }

        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
        }

        .stat-card .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Productos */
        .products-actions {
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .product-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s;
        }

        .product-card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transform: translateY(-3px);
        }

        .product-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 24px;
        }

        .product-info {
            flex: 1;
        }

        .product-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .product-desc {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .product-price {
            font-size: 20px;
            font-weight: 700;
            color: #28a745;
            margin-bottom: 5px;
        }

        .product-meta {
            font-size: 12px;
            color: #999;
        }

        .product-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Drag & Drop */
        .drop-zone {
            border: 3px dashed #ccc;
            padding: 40px 20px;
            text-align: center;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
            position: relative;
        }

        .drop-zone:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .drop-zone.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.02);
        }

        .drop-zone-content {
            pointer-events: none;
        }

        .drop-zone-icon {
            font-size: 3em;
            margin-bottom: 15px;
            color: #667eea;
        }

        .drop-zone-text {
            font-size: 18px;
            font-weight: 500;
            color: #666;
            margin-bottom: 5px;
        }

        .drop-zone-subtext {
            font-size: 14px;
            color: #999;
        }

        .image-preview {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .image-wrapper {
            position: relative;
            display: inline-block;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .image-wrapper:hover {
            transform: translateY(-5px);
        }

        .image-wrapper img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            display: block;
        }

        .image-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .image-remove:hover {
            background: #dc3545;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .upload-progress {
            margin-top: 15px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading-message {
            text-align: center;
            padding: 60px;
            color: #666;
            font-size: 18px;
        }

        .no-products {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .no-products-icon {
            font-size: 4em;
            margin-bottom: 20px;
            color: #ccc;
        }

        .hidden {
            display: none !important;
        }

        .category-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="connection-status loading" id="connectionStatus">üîÑ Conectando...</div>
            <a href="/" class="store-link" target="_blank">üõí Ver Tienda</a>
            <h1>üè™ Panel de Administraci√≥n</h1>
            <p>Gestiona tu tienda online Hern√°ndezStore</p>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showTab('products')">üì¶ Productos</button>
            <button class="nav-tab" onclick="showTab('categories')">üìÇ Categor√≠as</button>
            <button class="nav-tab" onclick="showTab('add-product')">‚ûï A√±adir Producto</button>
        </div>
        
        <div class="content">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <h2>üìä Dashboard</h2>
                <div class="stats-grid">
                    <div class="stat-card products">
                        <h3>üì¶ Total Productos</h3>
                        <div class="stat-number" id="total-products">--</div>
                        <div>En cat√°logo</div>
                    </div>
                    <div class="stat-card categories">
                        <h3>üìÇ Categor√≠as</h3>
                        <div class="stat-number" id="total-categories">--</div>
                        <div>Disponibles</div>
                    </div>
                    <div class="stat-card low-stock">
                        <h3>‚ö†Ô∏è Stock Bajo</h3>
                        <div class="stat-number" id="low-stock">--</div>
                        <div>Productos</div>
                    </div>
                    <div class="stat-card total-value">
                        <h3>üí∞ Valor Total</h3>
                        <div class="stat-number" id="total-value">--</div>
                        <div>Inventario</div>
                    </div>
                </div>
                <div id="server-info" style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-top: 20px;">
                    <h4>üîó Estado del Servidor</h4>
                    <p><strong>URL:</strong> <span id="api-url">http://localhost:4000</span></p>
                    <p><strong>Base de datos:</strong> SQLite</p>
                    <p><strong>√öltima actualizaci√≥n:</strong> <span id="last-update">--</span></p>
                </div>
            </div>

            <!-- Products Tab -->
            <div id="products" class="tab-content">
                <h2>üì¶ Gesti√≥n de Productos</h2>
                <div class="products-actions">
                    <button class="btn btn-success" onclick="loadProducts()">üîÑ Actualizar Lista</button>
                    <button class="btn btn-secondary" onclick="exportProducts()">üì§ Exportar JSON</button>
                    <span id="products-count" style="margin-left: auto; color: #666;"></span>
                </div>
                <div id="products-list">
                    <div class="loading-message">üîÑ Cargando productos...</div>
                </div>
            </div>

            <!-- Categories Tab -->
            <div id="categories" class="tab-content">
                <h2>üìÇ Gesti√≥n de Categor√≠as</h2>
                <div class="products-actions">
                    <button class="btn btn-success" onclick="loadCategories()">üîÑ Actualizar</button>
                    <button class="btn btn-success" onclick="showAddCategoryForm()">‚ûï Nueva Categor√≠a</button>
                </div>
                
                <div id="add-category-form" class="hidden" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4>‚ûï A√±adir Nueva Categor√≠a</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>ID de la Categor√≠a</label>
                            <input type="text" id="category-name" placeholder="ej: electronica">
                        </div>
                        <div class="form-group">
                            <label>Nombre a Mostrar</label>
                            <input type="text" id="category-label" placeholder="ej: Electr√≥nica">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="addCategory()">üíæ Guardar</button>
                    <button class="btn btn-secondary" onclick="hideAddCategoryForm()">‚ùå Cancelar</button>
                </div>
                
                <div id="categories-list">
                    <div class="loading-message">üîÑ Cargando categor√≠as...</div>
                </div>
            </div>

            <!-- Add Product Tab -->
            <div id="add-product" class="tab-content">
                <h2 id="form-title">‚ûï A√±adir Nuevo Producto</h2>
                
                <div id="alertContainer"></div>
                
                <form id="product-form">
                    <input type="hidden" id="product-id" value="">
                    
                    <div class="form-group">
                        <label>Nombre del Producto *</label>
                        <input type="text" id="product-name" required placeholder="Ej: iPhone 15 Pro Max">
                    </div>
                    
                    <div class="form-group">
                        <label>Descripci√≥n Corta</label>
                        <textarea id="product-desc" rows="3" placeholder="Descripci√≥n breve del producto..."></textarea>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Precio (S/.) *</label>
                            <input type="number" id="product-price" step="0.01" min="0" required placeholder="0.00">
                        </div>
                        
                        <div class="form-group">
                            <label>Categor√≠a *</label>
                            <select id="product-category" required>
                                <option value="">Selecciona una categor√≠a</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Descuento (%)</label>
                            <input type="number" id="product-discount" min="0" max="100" value="0" placeholder="0">
                        </div>
                        
                        <div class="form-group">
                            <label>Stock *</label>
                            <input type="number" id="product-stock" min="0" value="0" required placeholder="0">
                        </div>
                    </div>
                    
                    <!-- Zona de Drag & Drop para Im√°genes -->
                    <div class="form-group">
                        <label>Im√°genes del Producto</label>
                        
                        <div id="drop-zone" class="drop-zone">
                            <div class="drop-zone-content">
                                <div class="drop-zone-icon">üì∑</div>
                                <div class="drop-zone-text">Arrastra tus im√°genes aqu√≠</div>
                                <div class="drop-zone-subtext">o haz clic para seleccionar archivos</div>
                                <div class="drop-zone-subtext">Formatos: JPG, PNG, GIF - M√°ximo 5MB por imagen</div>
                            </div>
                        </div>
                        
                        <input type="file" id="imageInput" multiple accept="image/*" class="hidden">
                        
                        <div class="upload-progress" id="uploadProgress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                        </div>
                        
                        <div id="imagePreview" class="image-preview"></div>
                    </div>
                    
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee;">
                        <button type="submit" class="btn btn-success" id="submit-btn">üíæ Guardar Producto</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelEdit()">‚ùå Cancelar</button>
                        <button type="reset" class="btn btn-secondary">üóëÔ∏è Limpiar Formulario</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        // ===== CONFIGURACI√ìN GLOBAL =====
        const API_BASE = 'http://localhost:4000/api';
        let storeData = {
            products: [],
            categories: [],
            config: {}
        };
        let uploadedImages = [];

        // ===== INICIALIZACI√ìN =====
        document.addEventListener('DOMContentLoaded', function() {
            testConnection();
            loadData();
        });

        // ===== CONEXI√ìN AL SERVIDOR =====
        async function testConnection() {
            const statusEl = document.getElementById('connectionStatus');
            
            try {
                statusEl.textContent = 'üîÑ Conectando...';
                statusEl.className = 'connection-status loading';
                
                const response = await fetch(`${API_BASE}/test`);
                const data = await response.json();
                
                if (data.success) {
                    statusEl.textContent = '‚úÖ Conectado';
                    statusEl.className = 'connection-status connected';
                    document.getElementById('last-update').textContent = new Date().toLocaleString();
                } else {
                    throw new Error('Test fall√≥');
                }
            } catch (error) {
                console.error('Error de conexi√≥n:', error);
                statusEl.textContent = '‚ùå Sin conexi√≥n';
                statusEl.className = 'connection-status disconnected';
                showAlert('Error conectando al servidor. Verifica que est√© corriendo en puerto 4000.', 'error');
            }
        }

        // ===== CARGAR DATOS =====
        async function loadData() {
            try {
                const response = await fetch(`${API_BASE}/data`);
                const data = await response.json();
                
                storeData = data;
                updateStats();
                updateCategorySelect();
                
                console.log('‚úÖ Datos cargados:', data);
            } catch (error) {
                console.error('Error cargando datos:', error);
                showAlert('Error cargando datos del servidor', 'error');
            }
        }

        // ===== ESTAD√çSTICAS =====
        function updateStats() {
            const { products, categories } = storeData;
            
            document.getElementById('total-products').textContent = products.length;
            document.getElementById('total-categories').textContent = categories.length;
            
            const lowStock = products.filter(p => p.stock < 10).length;
            document.getElementById('low-stock').textContent = lowStock;
            
            const totalValue = products.reduce((sum, p) => sum + (p.price * p.stock), 0);
            document.getElementById('total-value').textContent = `S/. ${totalValue.toFixed(0)}`;
        }

        // ===== GESTI√ìN DE PESTA√ëAS =====
        function showTab(tabName) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remover clase active de todos los botones
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar pesta√±a seleccionada
            document.getElementById(tabName).classList.add('active');
            
            // Activar bot√≥n correspondiente
            event.target.classList.add('active');

            // Cargar datos espec√≠ficos seg√∫n la pesta√±a
            if (tabName === 'products') loadProducts();
            if (tabName === 'categories') loadCategories();
        }

        // ===== GESTI√ìN DE PRODUCTOS =====
        async function loadProducts() {
            const productsList = document.getElementById('products-list');
            const productsCount = document.getElementById('products-count');
            
            productsList.innerHTML = '<div class="loading-message">üîÑ Cargando productos...</div>';
            
            try {
                await loadData(); // Recargar datos
                const { products } = storeData;
                
                if (products.length === 0) {
                    productsList.innerHTML = `
                        <div class="no-products">
                            <div class="no-products-icon">üì¶</div>
                            <h3>No hay productos</h3>
                            <p>Agrega tu primer producto usando la pesta√±a "A√±adir Producto"</p>
                        </div>
                    `;
                } else {
                    let html = '';
                    products.forEach(product => {
                        const mainImage = product.images && product.images.length > 0 
                            ? product.images[0] 
                            : null;
                        
                        const stockStatus = product.stock < 10 ? '‚ö†Ô∏è Stock bajo' : `${product.stock} disponibles`;
                        const finalPrice = product.discount > 0 
                            ? product.price * (1 - product.discount / 100)
                            : product.price;
                        
                        html += `
                            <div class="product-card">
                                <div class="product-image">
                                    ${mainImage 
                                        ? `<img src="${mainImage}" alt="${product.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">` 
                                        : 'üì∑'
                                    }
                                </div>
                                <div class="product-info">
                                    <div class="product-name">${product.name}</div>
                                    <div class="product-desc">${product.shortDesc || 'Sin descripci√≥n'}</div>
                                    <div class="product-price">
                                        ${product.discount > 0 
                                            ? `<span style="text-decoration: line-through; color: #999; font-size: 14px;">S/. ${product.price.toFixed(2)}</span> S/. ${finalPrice.toFixed(2)}`
                                            : `S/. ${product.price.toFixed(2)}`
                                        }
                                    </div>
                                    <div class="product-meta">
                                        üìÇ ${getCategoryLabel(product.category)} | üì¶ ${stockStatus} | üÜî #${product.id}
                                    </div>
                                </div>
                                <div class="product-actions">
                                    <button class="btn btn-warning btn-small" onclick="editProduct(${product.id})">‚úèÔ∏è Editar</button>
                                    <button class="btn btn-danger btn-small" onclick="deleteProduct(${product.id})">üóëÔ∏è Eliminar</button>
                                </div>
                            </div>
                        `;
                    });
                    productsList.innerHTML = html;
                }
                
                productsCount.textContent = `${products.length} productos encontrados`;
                
            } catch (error) {
                console.error('Error cargando productos:', error);
                productsList.innerHTML = '<div class="loading-message">‚ùå Error cargando productos</div>';
            }
        }

        function getCategoryLabel(categoryName) {
            const category = storeData.categories.find(c => c.name === categoryName);
            return category ? category.label : categoryName;
        }

        async function deleteProduct(id) {
            if (!confirm('¬øEst√°s seguro de eliminar este producto?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/products/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Producto eliminado correctamente');
                    loadProducts();
                    loadData(); // Actualizar stats
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error eliminando producto:', error);
                showAlert('Error eliminando producto: ' + error.message, 'error');
            }
        }

        function editProduct(id) {
            const product = storeData.products.find(p => p.id === id);
            if (!product) {
                showAlert('Producto no encontrado', 'error');
                return;
            }
            
            // Cambiar a la pesta√±a de a√±adir producto
            showTab('add-product');
            
            // Cambiar el t√≠tulo y bot√≥n
            document.getElementById('form-title').textContent = '‚úèÔ∏è Editar Producto';
            document.getElementById('submit-btn').textContent = 'üíæ Actualizar Producto';
            
            // Llenar el formulario con los datos existentes
            document.getElementById('product-id').value = product.id;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-desc').value = product.shortDesc || '';
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-category').value = product.category;
            document.getElementById('product-discount').value = product.discount || 0;
            document.getElementById('product-stock').value = product.stock || 0;
            
            // Cargar im√°genes existentes
            uploadedImages = [...(product.images || [])];
            loadExistingImages(product.images || []);
            
            // Scroll hacia arriba para mostrar el formulario
            document.querySelector('.container').scrollIntoView({ behavior: 'smooth' });
            
            showAlert(`Editando producto: ${product.name}`, 'success');
        }

        function loadExistingImages(images) {
            const imagePreview = document.getElementById('imagePreview');
            imagePreview.innerHTML = '';
            
            images.forEach(imageUrl => {
                addImageToPreview(imageUrl, imageUrl);
            });
        }

        function cancelEdit() {
            // Resetear formulario
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            uploadedImages = [];
            document.getElementById('imagePreview').innerHTML = '';
            
            // Restaurar t√≠tulos
            document.getElementById('form-title').textContent = '‚ûï A√±adir Nuevo Producto';
            document.getElementById('submit-btn').textContent = 'üíæ Guardar Producto';
            
            // Limpiar alertas
            document.getElementById('alertContainer').innerHTML = '';
            
            showAlert('Edici√≥n cancelada');
        }

        function exportProducts() {
            const dataStr = JSON.stringify(storeData.products, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `productos_${new Date().getTime()}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showAlert('Productos exportados correctamente');
        }

        // ===== GESTI√ìN DE CATEGOR√çAS =====
        async function loadCategories() {
            const categoriesList = document.getElementById('categories-list');
            
            categoriesList.innerHTML = '<div class="loading-message">üîÑ Cargando categor√≠as...</div>';
            
            try {
                await loadData(); // Recargar datos
                const { categories } = storeData;
                
                if (categories.length === 0) {
                    categoriesList.innerHTML = `
                        <div class="no-products">
                            <div class="no-products-icon">üìÇ</div>
                            <h3>No hay categor√≠as</h3>
                            <p>Agrega tu primera categor√≠a</p>
                        </div>
                    `;
                } else {
                    let html = '';
                    categories.forEach(category => {
                        const productCount = storeData.products.filter(p => p.category === category.name).length;
                        html += `
                            <div class="category-card">
                                <div>
                                    <strong>${category.label}</strong>
                                    <div style="font-size: 12px; color: #666;">
                                        ID: ${category.name} | ${productCount} productos
                                    </div>
                                </div>
                                <div>
                                    <button class="btn btn-danger btn-small" onclick="deleteCategory(${category.id})">üóëÔ∏è Eliminar</button>
                                </div>
                            </div>
                        `;
                    });
                    categoriesList.innerHTML = html;
                }
                
            } catch (error) {
                console.error('Error cargando categor√≠as:', error);
                categoriesList.innerHTML = '<div class="loading-message">‚ùå Error cargando categor√≠as</div>';
            }
        }

        function showAddCategoryForm() {
            document.getElementById('add-category-form').classList.remove('hidden');
        }

        function hideAddCategoryForm() {
            document.getElementById('add-category-form').classList.add('hidden');
            document.getElementById('category-name').value = '';
            document.getElementById('category-label').value = '';
        }

        async function addCategory() {
            const name = document.getElementById('category-name').value.trim();
            const label = document.getElementById('category-label').value.trim();
            
            if (!name || !label) {
                showAlert('Por favor completa todos los campos', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/categories`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, label })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Categor√≠a agregada correctamente');
                    hideAddCategoryForm();
                    loadCategories();
                    loadData(); // Actualizar datos globales
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error agregando categor√≠a:', error);
                showAlert('Error agregando categor√≠a: ' + error.message, 'error');
            }
        }

        async function deleteCategory(id) {
            if (!confirm('¬øEst√°s seguro de eliminar esta categor√≠a?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/categories/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Categor√≠a eliminada correctamente');
                    loadCategories();
                    loadData(); // Actualizar datos globales
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error eliminando categor√≠a:', error);
                showAlert('Error eliminando categor√≠a: ' + error.message, 'error');
            }
        }

        function updateCategorySelect() {
            const select = document.getElementById('product-category');
            select.innerHTML = '<option value="">Selecciona una categor√≠a</option>';
            
            storeData.categories.forEach(category => {
                select.innerHTML += `<option value="${category.name}">${category.label}</option>`;
            });
        }

        // ===== DRAG & DROP DE IM√ÅGENES =====
        const dropZone = document.getElementById('drop-zone');
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressFill = document.getElementById('progressFill');

        // Eventos del drag & drop
        dropZone.addEventListener('click', () => {
            imageInput.click();
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => 
                file.type.startsWith('image/')
            );
            
            if (files.length > 0) {
                handleImageUpload(files);
            }
        });

        imageInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                handleImageUpload(files);
            }
        });

        // Funci√≥n para manejar la subida de im√°genes al servidor real
        async function handleImageUpload(files) {
            // Validar archivos
            const validFiles = files.filter(file => {
                if (!file.type.startsWith('image/')) {
                    showAlert(`${file.name} no es una imagen v√°lida`, 'error');
                    return false;
                }
                if (file.size > 5 * 1024 * 1024) { // 5MB m√°ximo
                    showAlert(`${file.name} es demasiado grande (m√°ximo 5MB)`, 'error');
                    return false;
                }
                return true;
            });

            if (validFiles.length === 0) return;

            // Mostrar progreso
            uploadProgress.style.display = 'block';
            progressFill.style.width = '0%';
            
            try {
                const formData = new FormData();
                validFiles.forEach(file => {
                    formData.append('images', file);
                });
                
                // Simular progreso
                progressFill.style.width = '50%';
                
                const response = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Completar progreso
                    progressFill.style.width = '100%';
                    
                    // A√±adir URLs al array de im√°genes
                    result.urls.forEach(url => {
                        const fullUrl = `http://localhost:4000${url}`;
                        uploadedImages.push(fullUrl);
                        addImageToPreview(fullUrl, url);
                    });
                    
                    showAlert(`${validFiles.length} imagen(es) subida(s) correctamente!`);
                } else {
                    throw new Error(result.message || 'Error desconocido');
                }
                
            } catch (error) {
                console.error('Error subiendo im√°genes:', error);
                showAlert(`Error subiendo im√°genes: ${error.message}`, 'error');
            } finally {
                // Ocultar progreso despu√©s de un delay
                setTimeout(() => {
                    uploadProgress.style.display = 'none';
                    progressFill.style.width = '0%';
                }, 1000);
            }
        }

        // A√±adir imagen al preview
        function addImageToPreview(fullUrl, shortUrl) {
            const wrapper = document.createElement('div');
            wrapper.className = 'image-wrapper';
            wrapper.dataset.imageUrl = fullUrl;
            
            wrapper.innerHTML = `
                <img src="${fullUrl}" alt="Imagen del producto">
                <button type="button" class="image-remove" onclick="removeImage('${fullUrl}')">√ó</button>
            `;
            
            imagePreview.appendChild(wrapper);
        }

        // Remover imagen
        function removeImage(imageUrl) {
            // Remover del array
            uploadedImages = uploadedImages.filter(url => url !== imageUrl);
            
            // Remover del DOM
            const wrapper = document.querySelector(`[data-image-url="${imageUrl}"]`);
            if (wrapper) {
                wrapper.remove();
            }
            
            showAlert('Imagen eliminada del preview (no se elimina del servidor)');
        }

        // ===== FORMULARIO DE PRODUCTOS =====
        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productId = document.getElementById('product-id').value;
            const isEditing = !!productId;
            
            const formData = {
                name: document.getElementById('product-name').value.trim(),
                shortDesc: document.getElementById('product-desc').value.trim(),
                price: parseFloat(document.getElementById('product-price').value),
                category: document.getElementById('product-category').value,
                discount: parseInt(document.getElementById('product-discount').value) || 0,
                stock: parseInt(document.getElementById('product-stock').value),
                images: uploadedImages
            };
            
            // Validaciones
            if (!formData.name || !formData.category || !formData.price || formData.stock < 0) {
                showAlert('Por favor completa todos los campos obligatorios', 'error');
                return;
            }
            
            try {
                let response;
                
                if (isEditing) {
                    // ACTUALIZAR producto existente
                    response = await fetch(`${API_BASE}/products/${productId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                } else {
                    // CREAR producto nuevo
                    response = await fetch(`${API_BASE}/products`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                }
                
                const result = await response.json();
                
                if (result.success) {
                    if (isEditing) {
                        showAlert(`‚úÖ Producto "${formData.name}" actualizado correctamente!`);
                    } else {
                        showAlert(`‚úÖ Producto "${formData.name}" creado correctamente!`);
                    }
                    
                    // Limpiar formulario
                    document.getElementById('product-form').reset();
                    document.getElementById('product-id').value = '';
                    uploadedImages = [];
                    document.getElementById('imagePreview').innerHTML = '';
                    
                    // Restaurar t√≠tulos
                    document.getElementById('form-title').textContent = '‚ûï A√±adir Nuevo Producto';
                    document.getElementById('submit-btn').textContent = 'üíæ Guardar Producto';
                    
                    // Actualizar datos
                    loadData();
                    
                    // Si estaba editando, regresar a la lista de productos
                    if (isEditing) {
                        setTimeout(() => {
                            showTab('products');
                        }, 1500);
                    }
                    
                    console.log('Operaci√≥n exitosa:', result.product);
                } else {
                    throw new Error(result.error || 'Error desconocido');
                }
                
            } catch (error) {
                console.error('Error procesando producto:', error);
                const action = isEditing ? 'actualizando' : 'creando';
                showAlert(`Error ${action} producto: ${error.message}`, 'error');
            }
        });

        // Limpiar formulario
        document.getElementById('product-form').addEventListener('reset', () => {
            uploadedImages = [];
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('product-id').value = '';
            
            // Restaurar t√≠tulos
            document.getElementById('form-title').textContent = '‚ûï A√±adir Nuevo Producto';
            document.getElementById('submit-btn').textContent = 'üíæ Guardar Producto';
            
            // Limpiar alertas
            document.getElementById('alertContainer').innerHTML = '';
        });

        // ===== UTILIDADES =====
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            
            alertContainer.innerHTML = `
                <div class="alert ${alertClass}">
                    ${message}
                </div>
            `;
            
            // Auto-ocultar despu√©s de 5 segundos
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
            
            // Scroll hacia arriba para mostrar la alerta
            alertContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    </script>
</body>
</html>