<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Hernandezstore - Panel de Administraci√≥n</title>
<style>
body { font-family: Arial, sans-serif; background: #121212; color: white; margin: 0; }
header { background: #1e1e1e; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
header h1 { margin: 0; font-size: 1.2rem; }
header button { background: #ff4b4b; border: none; padding: 0.5rem 1rem; color: white; cursor: pointer; border-radius: 4px; }
header button:hover { background: #cc0000; }
.container { max-width: 900px; margin: auto; padding: 1rem; }
input, select, textarea { width: 100%; padding: 0.5rem; margin: 0.25rem 0; background: #1e1e1e; border: none; color: white; border-radius: 4px; box-sizing: border-box; }
button { padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; margin: 0.25rem; }
.add-btn { background: #6200ee; color: white; }
.save-btn { background: #4CAF50; color: white; }
.cancel-btn { background: #777; color: white; }
.edit-btn { background: orange; color: black; }
.delete-btn { background: red; color: white; }
.product { background: #1e1e1e; padding: 0.5rem; margin: 0.5rem 0; display: flex; justify-content: space-between; align-items: center; border-radius: 6px; }
.product img { max-height: 40px; margin-right: 10px; border-radius: 4px; }
.img-preview { max-height: 120px; margin-top: 10px; display: block; border-radius: 8px; border: 2px solid #333; }

/* Estilos para imagen de fallback */
.no-image-placeholder {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #444, #222);
    border-radius: 4px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-right: 10px;
    color: #999;
    font-size: 10px;
    text-align: center;
    font-weight: bold;
    border: 1px solid #555;
}

/* Zona de arrastrar y soltar */
.image-upload-area {
    border: 2px dashed #555;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    margin: 1rem 0;
    background: #1a1a1a;
    transition: all 0.3s ease;
    cursor: pointer;
}

.image-upload-area.drag-over {
    border-color: #6200ee;
    background: #2a1a4a;
}

.image-upload-area:hover {
    border-color: #777;
    background: #252525;
}

.upload-icon {
    font-size: 3rem;
    color: #555;
    margin-bottom: 1rem;
}

.upload-text {
    color: #aaa;
    font-size: 1rem;
    margin-bottom: 0.5rem;
}

.upload-subtext {
    color: #777;
    font-size: 0.9rem;
}

.image-options {
    display: flex;
    gap: 1rem;
    margin: 1rem 0;
    align-items: center;
}

.image-options label {
    color: #ccc;
    font-weight: bold;
}

.url-input {
    flex: 1;
}

.add-url-btn {
    background: #6200ee;
    color: white;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    white-space: nowrap;
}

.add-url-btn:hover {
    background: #5000cc;
}

.image-preview-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.image-item {
    position: relative;
    display: inline-block;
}

.image-item img {
    max-height: 80px;
    max-width: 80px;
    object-fit: cover;
    border-radius: 6px;
    border: 2px solid #333;
}

.remove-image {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff4444;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.remove-image:hover {
    background: #cc0000;
}

.hidden-file-input {
    display: none;
}

/* Responsive */
@media (max-width: 600px) {
    .image-options {
        flex-direction: column;
        align-items: stretch;
    }
    
    .add-url-btn {
        margin-top: 0.5rem;
    }
}

/* Estilos para importador CSV */
.csv-import-section {
    background: #1a1a1a;
    border-radius: 8px;
    padding: 1.5rem;
    margin: 1rem 0;
    border: 1px solid #333;
}

.csv-import-section h3 {
    margin-top: 0;
    color: #fff;
    font-size: 1.1rem;
}

.csv-upload-area {
    border: 2px dashed #555;
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
    margin: 1rem 0;
    background: #252525;
    transition: all 0.3s ease;
    cursor: pointer;
}

.csv-upload-area.drag-over {
    border-color: #4CAF50;
    background: #1a3a1a;
}

.csv-upload-area:hover {
    border-color: #777;
    background: #2a2a2a;
}

.csv-options {
    display: flex;
    gap: 0.5rem;
    margin: 1rem 0;
    flex-wrap: wrap;
}

.template-btn {
    background: #2196F3;
    color: white;
}

.template-btn:hover {
    background: #1976D2;
}

.import-btn {
    background: #4CAF50;
    color: white;
}

.import-btn:hover {
    background: #45a049;
}

.csv-preview {
    background: #2a2a2a;
    border-radius: 6px;
    padding: 1rem;
    margin: 1rem 0;
}

.csv-preview h4 {
    margin: 0 0 1rem 0;
    color: #fff;
}

.csv-table-container {
    overflow-x: auto;
    margin: 1rem 0;
}

.csv-table-container table {
    width: 100%;
    border-collapse: collapse;
    background: #1e1e1e;
    border-radius: 4px;
    overflow: hidden;
}

.csv-table-container th,
.csv-table-container td {
    padding: 0.5rem;
    text-align: left;
    border-bottom: 1px solid #444;
    color: white;
    font-size: 0.9rem;
}

.csv-table-container th {
    background: #333;
    font-weight: bold;
}

.csv-table-container tr:hover {
    background: #333;
}

#csvStats {
    color: #aaa;
    font-size: 0.9rem;
    margin: 0.5rem 0;
}

/* Mensaje de error de imagen */
.image-error {
    color: #ff6b6b;
    font-size: 0.8rem;
    margin-top: 0.25rem;
}

/* Estado de carga */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

.error-message {
    background: #ff4444;
    color: white;
    padding: 0.5rem;
    border-radius: 4px;
    margin: 0.5rem 0;
    font-size: 0.9rem;
}

.success-message {
    background: #4CAF50;
    color: white;
    padding: 0.5rem;
    border-radius: 4px;
    margin: 0.5rem 0;
    font-size: 0.9rem;
}

/* Modal para ver im√°genes grandes */
.image-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    animation: fadeIn 0.3s ease;
}

.image-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    position: relative;
    max-width: 90vw;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    animation: zoomIn 0.3s ease;
}

.modal-image {
    max-width: 100%;
    max-height: 80vh;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1);
}

.modal-close {
    position: absolute;
    top: -40px;
    right: 0;
    color: #fff;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    background: rgba(0, 0, 0, 0.5);
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.3s ease;
}

.modal-close:hover {
    background: rgba(255, 0, 0, 0.7);
}

.modal-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.5);
    color: white;
    border: none;
    font-size: 24px;
    padding: 10px 15px;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.3s ease;
}

.modal-nav:hover {
    background: rgba(255, 255, 255, 0.2);
}

.modal-nav.prev {
    left: -60px;
}

.modal-nav.next {
    right: -60px;
}

.modal-nav:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

.image-counter {
    color: white;
    margin-top: 10px;
    font-size: 14px;
    background: rgba(0, 0, 0, 0.5);
    padding: 5px 10px;
    border-radius: 15px;
}

.modal-info {
    color: white;
    margin-top: 10px;
    text-align: center;
    max-width: 500px;
}

.modal-info h3 {
    margin: 0 0 5px 0;
    font-size: 1.2rem;
}

.modal-info p {
    margin: 0;
    font-size: 0.9rem;
    opacity: 0.8;
}

/* Animaciones */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes zoomIn {
    from { transform: scale(0.8); }
    to { transform: scale(1); }
}

/* Responsive para modal */
@media (max-width: 768px) {
    .modal-nav.prev {
        left: 10px;
    }
    
    .modal-nav.next {
        right: 10px;
    }
    
    .modal-close {
        top: 10px;
        right: 10px;
    }
    
    .modal-nav {
        font-size: 20px;
        padding: 8px 12px;
    }
}

/* Hacer las im√°genes de producto clickeables */
.product img {
    cursor: pointer;
    transition: transform 0.2s ease;
}

.product img:hover {
    transform: scale(1.05);
}

.image-item img {
    cursor: pointer;
    transition: transform 0.2s ease;
}

.image-item img:hover {
    transform: scale(1.1);
}
</style>
</head>
<body>
<header>
  <h1>Panel de Administraci√≥n</h1>
  <button onclick="logout()">Cerrar sesi√≥n</button>
</header>
<div class="container">
  <h2>Lista de Productos</h2>
  
  <!-- Secci√≥n de importaci√≥n CSV -->
  <div class="csv-import-section">
    <h3>Importar Productos desde CSV</h3>
    <div class="csv-upload-area" id="csvUploadArea">
      <div class="upload-icon">üìä</div>
      <div class="upload-text">Arrastra un archivo CSV aqu√≠ o haz clic para seleccionar</div>
      <div class="upload-subtext">Formato: nombre,descripcion,precio,stock,categoria,descuento,imagen_url</div>
    </div>
    <input type="file" id="csvFile" class="hidden-file-input" accept=".csv,.txt" />
    
    <div class="csv-options">
      <button id="downloadTemplate" class="template-btn">üì• Descargar Plantilla CSV</button>
      <button id="importCsv" class="import-btn" style="display:none;">üì§ Importar Productos</button>
      <button id="cancelImport" class="cancel-btn" style="display:none;">‚ùå Cancelar</button>
    </div>
    
    <div id="csvPreview" class="csv-preview" style="display:none;">
      <h4>Vista previa (primeras 5 filas):</h4>
      <div class="csv-table-container">
        <table id="csvPreviewTable"></table>
      </div>
      <p id="csvStats"></p>
    </div>
  </div>
  
  <div id="list"></div>
  <h3 id="form-title">Agregar producto</h3>
  <input id="name" placeholder="Nombre del producto">
  <textarea id="shortDesc" placeholder="Descripci√≥n corta"></textarea>
  <input id="price" placeholder="Precio" type="number" step="0.01">
  <input id="stock" placeholder="Cantidad en stock" type="number" min="0" step="1">
  <select id="category"></select>
  <input id="newCategory" placeholder="Nueva categor√≠a (opcional)">
  <input id="discount" placeholder="Descuento (%)" type="number" min="0" max="100">
  
  <!-- Nueva √°rea de carga de im√°genes -->
  <div class="image-upload-area" id="uploadArea">
    <div class="upload-icon">üñºÔ∏è</div>
    <div class="upload-text">Arrastra y suelta im√°genes aqu√≠</div>
    <div class="upload-subtext">o haz clic para seleccionar archivos</div>
  </div>
  
  <input type="file" id="image" class="hidden-file-input" multiple accept="image/*">
  
  <div class="image-options">
    <label>O pega una URL:</label>
    <input type="url" id="imageUrl" class="url-input" placeholder="https://ejemplo.com/imagen.jpg">
    <button type="button" class="add-url-btn" id="addUrlBtn">Agregar URL</button>
  </div>
  
  <div id="imagePreviewContainer" class="image-preview-container"></div>
  
  <button id="actionBtn" class="add-btn">Agregar</button>
  <button id="cancelBtn" class="cancel-btn" style="display:none;">Cancelar</button>
</div>

<!-- Modal para ver im√°genes grandes -->
<div id="imageModal" class="image-modal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeImageModal()">&times;</button>
        <button class="modal-nav prev" id="prevBtn" onclick="prevImage()">‚ùÆ</button>
        <button class="modal-nav next" id="nextBtn" onclick="nextImage()">‚ùØ</button>
        
        <img id="modalImage" class="modal-image" alt="Imagen del producto">
        
        <div class="image-counter" id="imageCounter"></div>
        
        <div class="modal-info" id="modalInfo">
            <h3 id="modalProductName"></h3>
            <p id="modalProductDesc"></p>
        </div>
    </div>
</div>

<script>
// Variables para el visor de im√°genes
let currentImageIndex = 0;
let currentModalImages = [];
let currentProduct = null;

// Funciones de utilidad para generar placeholders
function createPlaceholderSvg(width = 40, height = 40, text = 'IMG') {
    return `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`
        <svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
            <rect width="100%" height="100%" fill="#333"/>
            <rect width="100%" height="100%" fill="url(#gradient)" opacity="0.8"/>
            <defs>
                <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#444;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#222;stop-opacity:1" />
                </linearGradient>
            </defs>
            <text x="50%" y="50%" text-anchor="middle" dominant-baseline="central" 
                  fill="#999" font-family="Arial" font-size="${Math.min(width/4, 12)}" font-weight="bold">${text}</text>
        </svg>
    `)}`;
}

function createProductPlaceholder(productName = '', size = 40) {
    const initials = productName.split(' ')
        .map(word => word.trim()[0])
        .filter(letter => letter)
        .join('')
        .substring(0, 2)
        .toUpperCase() || 'P';
    
    const colors = ['#2196F3', '#4CAF50', '#FF9800', '#9C27B0', '#F44336', '#00BCD4'];
    const color = colors[productName.length % colors.length];
    
    return `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`
        <svg width="${size}" height="${size}" xmlns="http://www.w3.org/2000/svg">
            <circle cx="50%" cy="50%" r="45%" fill="${color}"/>
            <text x="50%" y="50%" text-anchor="middle" dominant-baseline="central" 
                  fill="white" font-family="Arial" font-size="${Math.min(size/2.5, 16)}" font-weight="bold">${initials}</text>
        </svg>
    `)}`;
}

// Sistema mejorado de manejo de im√°genes - SIN via.placeholder.com
class ImageManager {
    constructor() {
        this.retryCount = new Map();
        this.maxRetries = 1;
    }

    handleImageError(img, originalSrc, productName = '') {
        // Directamente usar placeholder sin intentar URLs externas problem√°ticas
        this.replaceWithPlaceholder(img, productName);
    }

    extractSizeFromUrl(url) {
        const match = url.match(/(\d+)/);
        return match ? parseInt(match[0]) : 40;
    }

    replaceWithPlaceholder(img, productName = '') {
        const size = img.width || img.height || 40;
        const placeholder = document.createElement('div');
        placeholder.className = 'no-image-placeholder';
        placeholder.style.width = size + 'px';
        placeholder.style.height = size + 'px';
        placeholder.textContent = productName ? 
            productName.substring(0, 2).toUpperCase() : 'IMG';
        
        if (img.parentNode) {
            img.parentNode.replaceChild(placeholder, img);
        }
    }

    loadImage(src, alt = '', className = '', productName = '') {
        return new Promise((resolve, reject) => {
            const img = document.createElement('img');
            img.alt = alt;
            img.className = className;
            
            img.onload = () => resolve(img);
            img.onerror = () => {
                this.handleImageError(img, src, productName);
                resolve(img); // Resolver aunque haya error, porque manejamos el fallback
            };
            
            img.src = src;
        });
    }
}

const imageManager = new ImageManager();

// FUNCIONES DEL VISOR DE IM√ÅGENES

// Funci√≥n para abrir el modal con las im√°genes del producto
function openImageModal(productIndex, imageIndex = 0) {
    const product = products[productIndex];
    if (!product) return;
    
    currentProduct = product;
    currentModalImages = product.images || [];
    currentImageIndex = imageIndex;
    
    // Si no hay im√°genes, crear una imagen placeholder
    if (currentModalImages.length === 0) {
        currentModalImages = [createProductPlaceholder(product.name, 400)];
    }
    
    updateModalContent();
    
    const modal = document.getElementById('imageModal');
    modal.classList.add('active');
    
    // Prevenir scroll del body
    document.body.style.overflow = 'hidden';
    
    // Agregar listener para cerrar con Escape
    document.addEventListener('keydown', handleKeyPress);
}

// Funci√≥n para cerrar el modal
function closeImageModal() {
    const modal = document.getElementById('imageModal');
    modal.classList.remove('active');
    
    // Restaurar scroll del body
    document.body.style.overflow = 'auto';
    
    // Remover listener de teclado
    document.removeEventListener('keydown', handleKeyPress);
    
    currentProduct = null;
    currentModalImages = [];
    currentImageIndex = 0;
}

// Funci√≥n para ir a la imagen anterior
function prevImage() {
    if (currentModalImages.length <= 1) return;
    currentImageIndex = (currentImageIndex - 1 + currentModalImages.length) % currentModalImages.length;
    updateModalContent();
}

// Funci√≥n para ir a la imagen siguiente
function nextImage() {
    if (currentModalImages.length <= 1) return;
    currentImageIndex = (currentImageIndex + 1) % currentModalImages.length;
    updateModalContent();
}

// Funci√≥n para actualizar el contenido del modal
function updateModalContent() {
    if (!currentProduct || currentModalImages.length === 0) return;
    
    const modalImage = document.getElementById('modalImage');
    const imageCounter = document.getElementById('imageCounter');
    const modalProductName = document.getElementById('modalProductName');
    const modalProductDesc = document.getElementById('modalProductDesc');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    
    // Actualizar imagen
    modalImage.src = currentModalImages[currentImageIndex];
    modalImage.alt = currentProduct.name;
    
    // Manejar error de carga de imagen
    modalImage.onerror = () => {
        modalImage.src = createProductPlaceholder(currentProduct.name, 400);
    };
    
    // Actualizar contador
    if (currentModalImages.length > 1) {
        imageCounter.textContent = `${currentImageIndex + 1} de ${currentModalImages.length}`;
        imageCounter.style.display = 'block';
    } else {
        imageCounter.style.display = 'none';
    }
    
    // Actualizar info del producto
    modalProductName.textContent = currentProduct.name;
    const price = `S/. ${currentProduct.price}`;
    const discount = currentProduct.discount ? ` (${currentProduct.discount}% desc.)` : '';
    const stock = currentProduct.stock !== undefined ? ` - Stock: ${currentProduct.stock}` : '';
    modalProductDesc.textContent = `${price}${discount}${stock}`;
    
    // Controlar navegaci√≥n
    prevBtn.disabled = currentModalImages.length <= 1;
    nextBtn.disabled = currentModalImages.length <= 1;
    
    prevBtn.style.display = currentModalImages.length > 1 ? 'block' : 'none';
    nextBtn.style.display = currentModalImages.length > 1 ? 'block' : 'none';
}

// Funci√≥n para manejar teclas del teclado
function handleKeyPress(e) {
    switch(e.key) {
        case 'Escape':
            closeImageModal();
            break;
        case 'ArrowLeft':
            prevImage();
            break;
        case 'ArrowRight':
            nextImage();
            break;
    }
}

// Cerrar modal al hacer clic fuera de la imagen
document.getElementById('imageModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeImageModal();
    }
});

function logout(){
  fetch('/logout', { method: 'POST' }).then(() => window.location.href = '/login.html');
}

let products = [];
let categories = [];
let editId = null;
let currentImages = []; // Array para m√∫ltiples im√°genes
let csvData = []; // Datos del CSV cargado

// Configurar drag & drop para im√°genes
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('image');
const imageUrl = document.getElementById('imageUrl');
const addUrlBtn = document.getElementById('addUrlBtn');
const previewContainer = document.getElementById('imagePreviewContainer');

// Configurar importador CSV
const csvUploadArea = document.getElementById('csvUploadArea');
const csvFileInput = document.getElementById('csvFile');
const downloadTemplate = document.getElementById('downloadTemplate');
const importCsv = document.getElementById('importCsv');
const cancelImport = document.getElementById('cancelImport');
const csvPreview = document.getElementById('csvPreview');

// Eventos de drag & drop para im√°genes
uploadArea.addEventListener('click', () => fileInput.click());
uploadArea.addEventListener('dragover', handleDragOver);
uploadArea.addEventListener('dragleave', handleDragLeave);
uploadArea.addEventListener('drop', handleDrop);
fileInput.addEventListener('change', handleFileSelect);
addUrlBtn.addEventListener('click', addImageUrl);

// Eventos para importador CSV
csvUploadArea.addEventListener('click', () => csvFileInput.click());
csvUploadArea.addEventListener('dragover', handleCsvDragOver);
csvUploadArea.addEventListener('dragleave', handleCsvDragLeave);
csvUploadArea.addEventListener('drop', handleCsvDrop);
csvFileInput.addEventListener('change', handleCsvFileSelect);
downloadTemplate.addEventListener('click', downloadCsvTemplate);
importCsv.addEventListener('click', importCsvData);
cancelImport.addEventListener('click', cancelCsvImport);

// Funci√≥n mejorada para manejar errores de imagen
function handleImageError(img, fallbackUrl = null, productName = '') {
    imageManager.handleImageError(img, img.src, productName);
}

function handleDragOver(e) {
    e.preventDefault();
    uploadArea.classList.add('drag-over');
}

function handleDragLeave(e) {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
}

function handleDrop(e) {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
    const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
    processFiles(files);
}

function handleFileSelect(e) {
    const files = Array.from(e.target.files);
    processFiles(files);
}

function processFiles(files) {
    files.forEach(file => {
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                addImageToPreview(e.target.result, 'file', file);
            };
            reader.readAsDataURL(file);
        }
    });
}

function addImageUrl() {
    const url = imageUrl.value.trim();
    if (url && isValidImageUrl(url)) {
        addImageToPreview(url, 'url');
        imageUrl.value = '';
    } else {
        alert('Por favor, ingresa una URL v√°lida de imagen');
    }
}

function isValidImageUrl(url) {
    try {
        new URL(url);
        return /\.(jpg|jpeg|png|gif|webp|svg)(\?|$)/i.test(url) || 
               url.includes('unsplash') || 
               url.includes('imgur') ||
               url.includes('picsum') ||
               url.includes('images.unsplash') ||
               url.startsWith('data:image/') ||
               url.startsWith('/') || // URLs relativas
               url.includes('cloudinary') ||
               url.includes('amazonaws');
    } catch {
        return false;
    }
}

function addImageToPreview(src, type, file = null) {
    const imageData = {
        src: src,
        type: type,
        file: file,
        id: Date.now() + Math.random()
    };
    
    currentImages.push(imageData);
    renderImagePreviews();
}

function removeImage(imageId) {
    currentImages = currentImages.filter(img => img.id !== imageId);
    renderImagePreviews();
}

function renderImagePreviews() {
    previewContainer.innerHTML = '';
    
    currentImages.forEach((image, index) => {
        const imageItem = document.createElement('div');
        imageItem.className = 'image-item';
        
        const img = document.createElement('img');
        img.src = image.src;
        img.alt = `Imagen ${index + 1}`;
        img.onerror = () => {
            img.src = createPlaceholderSvg(80, 80, 'IMG');
        };
        
        // Hacer la imagen clickeable para ver en modal
        img.onclick = () => {
            currentImageIndex = index;
            currentModalImages = currentImages.map(img => img.src);
            updateModalContent();
            document.getElementById('imageModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            document.addEventListener('keydown', handleKeyPress);
        };
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-image';
        removeBtn.innerHTML = '√ó';
        removeBtn.onclick = (e) => {
            e.stopPropagation();
            removeImage(image.id);
        };
        
        imageItem.appendChild(img);
        imageItem.appendChild(removeBtn);
        previewContainer.appendChild(imageItem);
    });
}

function handleCsvDragOver(e) {
    e.preventDefault();
    csvUploadArea.classList.add('drag-over');
}

function handleCsvDragLeave(e) {
    e.preventDefault();
    csvUploadArea.classList.remove('drag-over');
}

function handleCsvDrop(e) {
    e.preventDefault();
    csvUploadArea.classList.remove('drag-over');
    if (e.dataTransfer.files.length) {
        csvFileInput.files = e.dataTransfer.files;
        handleCsvFileSelect({ target: csvFileInput });
    }
}

function handleCsvFileSelect(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            csvData = parseCsv(e.target.result);
            showCsvPreview();
        } catch (error) {
            alert('Error al procesar el archivo CSV: ' + error.message);
        }
    };
    reader.readAsText(file);
}

function parseCsv(csvText) {
    const lines = csvText.split('\n').filter(line => line.trim());
    if (lines.length < 2) throw new Error('El archivo CSV est√° vac√≠o o no tiene suficientes filas');
    
    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
    const requiredFields = ['nombre', 'descripcion', 'precio', 'stock', 'categoria'];
    
    // Verificar campos requeridos
    const missingFields = requiredFields.filter(field => !headers.includes(field));
    if (missingFields.length) {
        throw new Error(`Faltan campos requeridos: ${missingFields.join(', ')}`);
    }
    
    return lines.slice(1).map(line => {
        const values = line.split(',');
        const product = {};
        headers.forEach((header, index) => {
            product[header] = values[index] ? values[index].trim() : '';
        });
        return product;
    });
}

function showCsvPreview() {
    if (!csvData.length) return;
    
    const table = document.getElementById('csvPreviewTable');
    table.innerHTML = '';
    
    // Crear encabezados
    const headers = Object.keys(csvData[0]);
    const headerRow = document.createElement('tr');
    headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
    });
    table.appendChild(headerRow);
    
    // Mostrar primeras 5 filas
    const previewRows = csvData.slice(0, 5);
    previewRows.forEach(row => {
        const tr = document.createElement('tr');
        headers.forEach(header => {
            const td = document.createElement('td');
            td.textContent = row[header] || '';
            tr.appendChild(td);
        });
        table.appendChild(tr);
    });
    
    // Mostrar estad√≠sticas
    document.getElementById('csvStats').textContent = 
        `Total de productos a importar: ${csvData.length} | Mostrando ${previewRows.length} de ejemplo`;
    
    // Mostrar controles de importaci√≥n
    csvPreview.style.display = 'block';
    importCsv.style.display = 'inline-block';
    cancelImport.style.display = 'inline-block';
}

function downloadCsvTemplate() {
    const headers = ['nombre', 'descripcion', 'precio', 'stock', 'categoria', 'descuento', 'imagen_url'];
    const exampleData = [
        ['Camiseta b√°sica', 'Camiseta de algod√≥n 100%', '25.99', '50', 'Ropa', '10', 'https://ejemplo.com/camiseta.jpg'],
        ['Zapatos deportivos', 'Zapatos para correr talla 42', '89.99', '30', 'Calzado', '', 'https://ejemplo.com/zapatos.jpg']
    ];
    
    let csvContent = headers.join(',') + '\n';
    exampleData.forEach(row => {
        csvContent += row.join(',') + '\n';
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', 'plantilla_productos.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function importCsvData() {
    if (!csvData.length) return;
    
    // Aqu√≠ ir√≠a la l√≥gica para enviar los datos al servidor
    // Por ahora solo mostramos un mensaje de √©xito
    alert(`Se importar√°n ${csvData.length} productos. En una implementaci√≥n real, esto enviar√≠a los datos al servidor.`);
    cancelCsvImport();
}

function cancelCsvImport() {
    csvFileInput.value = '';
    csvData = [];
    csvPreview.style.display = 'none';
    importCsv.style.display = 'none';
    cancelImport.style.display = 'none';
}

// Cargar productos y categor√≠as al iniciar
document.addEventListener('DOMContentLoaded', () => {
    // Aqu√≠ ir√≠a la carga inicial de datos desde el servidor
    // Por ahora usamos datos de ejemplo
    products = [
        { 
            id: 1, 
            name: 'Producto de ejemplo', 
            shortDesc: 'Descripci√≥n corta del producto', 
            price: 99.99, 
            stock: 10, 
            category: 'Electr√≥nicos', 
            discount: 15,
            images: [createPlaceholderSvg(400, 400, 'Ejemplo')]
        }
    ];
    
    categories = ['Electr√≥nicos', 'Ropa', 'Hogar'];
    
    renderProductList();
    renderCategoryOptions();
});

function renderProductList() {
    const list = document.getElementById('list');
    list.innerHTML = '';
    
    products.forEach((product, index) => {
        const productDiv = document.createElement('div');
        productDiv.className = 'product';
        
        // Mostrar primera imagen o placeholder
        const imgSrc = product.images && product.images.length ? product.images[0] : createProductPlaceholder(product.name);
        const img = document.createElement('img');
        img.src = imgSrc;
        img.alt = product.name;
        img.onerror = () => handleImageError(img, imgSrc, product.name);
        img.onclick = () => openImageModal(index);
        
        const infoDiv = document.createElement('div');
        infoDiv.style.flex = '1';
        infoDiv.innerHTML = `
            <strong>${product.name}</strong> - S/. ${product.price}
            ${product.discount ? ` (${product.discount}% desc.)` : ''}
            <div style="font-size:0.8rem;color:#aaa;">${product.shortDesc}</div>
            <div style="font-size:0.8rem;">Stock: ${product.stock} | Categor√≠a: ${product.category}</div>
        `;
        
        const buttonsDiv = document.createElement('div');
        buttonsDiv.style.display = 'flex';
        
        const editBtn = document.createElement('button');
        editBtn.className = 'edit-btn';
        editBtn.textContent = 'Editar';
        editBtn.onclick = () => editProduct(index);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = 'Eliminar';
        deleteBtn.onclick = () => deleteProduct(index);
        
        buttonsDiv.appendChild(editBtn);
        buttonsDiv.appendChild(deleteBtn);
        
        productDiv.appendChild(img);
        productDiv.appendChild(infoDiv);
        productDiv.appendChild(buttonsDiv);
        
        list.appendChild(productDiv);
    });
}

function renderCategoryOptions() {
    const select = document.getElementById('category');
    select.innerHTML = '';
    
    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        select.appendChild(option);
    });
    
    // Agregar opci√≥n para nueva categor√≠a
    const newOption = document.createElement('option');
    newOption.value = '_new';
    newOption.textContent = '-- Nueva categor√≠a --';
    select.appendChild(newOption);
}

function editProduct(index) {
    const product = products[index];
    if (!product) return;
    
    editId = product.id;
    document.getElementById('name').value = product.name;
    document.getElementById('shortDesc').value = product.shortDesc;
    document.getElementById('price').value = product.price;
    document.getElementById('stock').value = product.stock;
    document.getElementById('category').value = product.category;
    document.getElementById('discount').value = product.discount || '';
    
    // Cargar im√°genes
    currentImages = product.images ? product.images.map(src => ({
        src: src,
        type: 'url',
        id: Date.now() + Math.random()
    })) : [];
    renderImagePreviews();
    
    // Cambiar texto del bot√≥n
    document.getElementById('actionBtn').textContent = 'Guardar';
    document.getElementById('actionBtn').className = 'save-btn';
    document.getElementById('form-title').textContent = 'Editar producto';
    document.getElementById('cancelBtn').style.display = 'inline-block';
}

function deleteProduct(index) {
    if (confirm('¬øEst√°s seguro de que quieres eliminar este producto?')) {
        // Aqu√≠ ir√≠a la llamada al servidor para eliminar
        products.splice(index, 1);
        renderProductList();
    }
}

// Configurar evento del bot√≥n principal
document.getElementById('actionBtn').addEventListener('click', () => {
    if (editId !== null) {
        updateProduct();
    } else {
        addProduct();
    }
});

document.getElementById('cancelBtn').addEventListener('click', resetForm);

function addProduct() {
    const name = document.getElementById('name').value.trim();
    const shortDesc = document.getElementById('shortDesc').value.trim();
    const price = parseFloat(document.getElementById('price').value);
    const stock = parseInt(document.getElementById('stock').value);
    const categorySelect = document.getElementById('category');
    const newCategory = document.getElementById('newCategory').value.trim();
    const discount = parseInt(document.getElementById('discount').value) || 0;
    
    // Validaciones b√°sicas
    if (!name || isNaN(price) || isNaN(stock)) {
        alert('Por favor completa los campos requeridos (nombre, precio y stock)');
        return;
    }
    
    // Determinar categor√≠a
    let category;
    if (categorySelect.value === '_new' && newCategory) {
        category = newCategory;
        if (!categories.includes(category)) {
            categories.push(category);
            renderCategoryOptions();
        }
    } else {
        category = categorySelect.value;
    }
    
    // Crear nuevo producto
    const newProduct = {
        id: Date.now(), // ID temporal
        name,
        shortDesc,
        price,
        stock,
        category,
        discount,
        images: currentImages.map(img => img.src)
    };
    
    // Aqu√≠ ir√≠a la llamada al servidor para guardar
    products.push(newProduct);
    renderProductList();
    resetForm();
}

function updateProduct() {
    const name = document.getElementById('name').value.trim();
    const shortDesc = document.getElementById('shortDesc').value.trim();
    const price = parseFloat(document.getElementById('price').value);
    const stock = parseInt(document.getElementById('stock').value);
    const categorySelect = document.getElementById('category');
    const newCategory = document.getElementById('newCategory').value.trim();
    const discount = parseInt(document.getElementById('discount').value) || 0;
    
    // Validaciones b√°sicas
    if (!name || isNaN(price) || isNaN(stock)) {
        alert('Por favor completa los campos requeridos (nombre, precio y stock)');
        return;
    }
    
    // Determinar categor√≠a
    let category;
    if (categorySelect.value === '_new' && newCategory) {
        category = newCategory;
        if (!categories.includes(category)) {
            categories.push(category);
            renderCategoryOptions();
        }
    } else {
        category = categorySelect.value;
    }
    
    // Buscar producto a editar
    const index = products.findIndex(p => p.id === editId);
    if (index === -1) return;
    
    // Actualizar producto
    products[index] = {
        ...products[index],
        name,
        shortDesc,
        price,
        stock,
        category,
        discount,
        images: currentImages.map(img => img.src)
    };
    
    // Aqu√≠ ir√≠a la llamada al servidor para actualizar
    renderProductList();
    resetForm();
}

function resetForm() {
    document.getElementById('name').value = '';
    document.getElementById('shortDesc').value = '';
    document.getElementById('price').value = '';
    document.getElementById('stock').value = '';
    document.getElementById('category').value = '';
    document.getElementById('newCategory').value = '';
    document.getElementById('discount').value = '';
    
    currentImages = [];
    renderImagePreviews();
    
    editId = null;
    document.getElementById('actionBtn').textContent = 'Agregar';
    document.getElementById('actionBtn').className = 'add-btn';
    document.getElementById('form-title').textContent = 'Agregar producto';
    document.getElementById('cancelBtn').style.display = 'none';
}
</script>
</body>
</html>