<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Hernandezstore - Panel de Administraci√≥n</title>
<style>
body { font-family: Arial, sans-serif; background: #121212; color: white; margin: 0; }
header { background: #1e1e1e; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
header h1 { margin: 0; font-size: 1.2rem; }
header button { background: #ff4b4b; border: none; padding: 0.5rem 1rem; color: white; cursor: pointer; border-radius: 4px; }
header button:hover { background: #cc0000; }
.container { max-width: 900px; margin: auto; padding: 1rem; }
input, select, textarea { width: 100%; padding: 0.5rem; margin: 0.25rem 0; background: #1e1e1e; border: none; color: white; border-radius: 4px; box-sizing: border-box; }
button { padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; margin: 0.25rem; }
.add-btn { background: #6200ee; color: white; }
.save-btn { background: #4CAF50; color: white; }
.cancel-btn { background: #777; color: white; }
.edit-btn { background: orange; color: black; }
.delete-btn { background: red; color: white; }
.product { background: #1e1e1e; padding: 0.5rem; margin: 0.5rem 0; display: flex; justify-content: space-between; align-items: center; border-radius: 6px; }
.product img { max-height: 40px; margin-right: 10px; border-radius: 4px; }
.img-preview { max-height: 120px; margin-top: 10px; display: block; border-radius: 8px; border: 2px solid #333; }

/* Estilos para imagen de fallback */
.no-image-placeholder {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #444, #222);
    border-radius: 4px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-right: 10px;
    color: #999;
    font-size: 10px;
    text-align: center;
    font-weight: bold;
    border: 1px solid #555;
}

/* Zona de arrastrar y soltar */
.image-upload-area {
    border: 2px dashed #555;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    margin: 1rem 0;
    background: #1a1a1a;
    transition: all 0.3s ease;
    cursor: pointer;
}

.image-upload-area.drag-over {
    border-color: #6200ee;
    background: #2a1a4a;
}

.image-upload-area:hover {
    border-color: #777;
    background: #252525;
}

.upload-icon {
    font-size: 3rem;
    color: #555;
    margin-bottom: 1rem;
}

.upload-text {
    color: #aaa;
    font-size: 1rem;
    margin-bottom: 0.5rem;
}

.upload-subtext {
    color: #777;
    font-size: 0.9rem;
}

.image-options {
    display: flex;
    gap: 1rem;
    margin: 1rem 0;
    align-items: center;
}

.image-options label {
    color: #ccc;
    font-weight: bold;
}

.url-input {
    flex: 1;
}

.add-url-btn {
    background: #6200ee;
    color: white;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    white-space: nowrap;
}

.add-url-btn:hover {
    background: #5000cc;
}

.image-preview-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.image-item {
    position: relative;
    display: inline-block;
}

.image-item img {
    max-height: 80px;
    max-width: 80px;
    object-fit: cover;
    border-radius: 6px;
    border: 2px solid #333;
}

.remove-image {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff4444;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.remove-image:hover {
    background: #cc0000;
}

.hidden-file-input {
    display: none;
}

/* Responsive */
@media (max-width: 600px) {
    .image-options {
        flex-direction: column;
        align-items: stretch;
    }
    
    .add-url-btn {
        margin-top: 0.5rem;
    }
}

/* Estilos para importador CSV */
.csv-import-section {
    background: #1a1a1a;
    border-radius: 8px;
    padding: 1.5rem;
    margin: 1rem 0;
    border: 1px solid #333;
}

.csv-import-section h3 {
    margin-top: 0;
    color: #fff;
    font-size: 1.1rem;
}

.csv-upload-area {
    border: 2px dashed #555;
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
    margin: 1rem 0;
    background: #252525;
    transition: all 0.3s ease;
    cursor: pointer;
}

.csv-upload-area.drag-over {
    border-color: #4CAF50;
    background: #1a3a1a;
}

.csv-upload-area:hover {
    border-color: #777;
    background: #2a2a2a;
}

.csv-options {
    display: flex;
    gap: 0.5rem;
    margin: 1rem 0;
    flex-wrap: wrap;
}

.template-btn {
    background: #2196F3;
    color: white;
}

.template-btn:hover {
    background: #1976D2;
}

.import-btn {
    background: #4CAF50;
    color: white;
}

.import-btn:hover {
    background: #45a049;
}

.csv-preview {
    background: #2a2a2a;
    border-radius: 6px;
    padding: 1rem;
    margin: 1rem 0;
}

.csv-preview h4 {
    margin: 0 0 1rem 0;
    color: #fff;
}

.csv-table-container {
    overflow-x: auto;
    margin: 1rem 0;
}

.csv-table-container table {
    width: 100%;
    border-collapse: collapse;
    background: #1e1e1e;
    border-radius: 4px;
    overflow: hidden;
}

.csv-table-container th,
.csv-table-container td {
    padding: 0.5rem;
    text-align: left;
    border-bottom: 1px solid #444;
    color: white;
    font-size: 0.9rem;
}

.csv-table-container th {
    background: #333;
    font-weight: bold;
}

.csv-table-container tr:hover {
    background: #333;
}

#csvStats {
    color: #aaa;
    font-size: 0.9rem;
    margin: 0.5rem 0;
}

/* Mensaje de error de imagen */
.image-error {
    color: #ff6b6b;
    font-size: 0.8rem;
    margin-top: 0.25rem;
}

/* Estado de carga */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

.error-message {
    background: #ff4444;
    color: white;
    padding: 0.5rem;
    border-radius: 4px;
    margin: 0.5rem 0;
    font-size: 0.9rem;
}

.success-message {
    background: #4CAF50;
    color: white;
    padding: 0.5rem;
    border-radius: 4px;
    margin: 0.5rem 0;
    font-size: 0.9rem;
}
</style>
</head>
<body>
<header>
  <h1>Panel de Administraci√≥n</h1>
  <button onclick="logout()">Cerrar sesi√≥n</button>
</header>
<div class="container">
  <h2>Lista de Productos</h2>
  
  <!-- Secci√≥n de importaci√≥n CSV -->
  <div class="csv-import-section">
    <h3>Importar Productos desde CSV</h3>
    <div class="csv-upload-area" id="csvUploadArea">
      <div class="upload-icon">üìä</div>
      <div class="upload-text">Arrastra un archivo CSV aqu√≠ o haz clic para seleccionar</div>
      <div class="upload-subtext">Formato: nombre,descripcion,precio,stock,categoria,descuento,imagen_url</div>
    </div>
    <input type="file" id="csvFile" class="hidden-file-input" accept=".csv,.txt" />
    
    <div class="csv-options">
      <button id="downloadTemplate" class="template-btn">üì• Descargar Plantilla CSV</button>
      <button id="importCsv" class="import-btn" style="display:none;">üì§ Importar Productos</button>
      <button id="cancelImport" class="cancel-btn" style="display:none;">‚ùå Cancelar</button>
    </div>
    
    <div id="csvPreview" class="csv-preview" style="display:none;">
      <h4>Vista previa (primeras 5 filas):</h4>
      <div class="csv-table-container">
        <table id="csvPreviewTable"></table>
      </div>
      <p id="csvStats"></p>
    </div>
  </div>
  
  <div id="list"></div>
  <h3 id="form-title">Agregar producto</h3>
  <input id="name" placeholder="Nombre del producto">
  <textarea id="shortDesc" placeholder="Descripci√≥n corta"></textarea>
  <input id="price" placeholder="Precio" type="number" step="0.01">
  <input id="stock" placeholder="Cantidad en stock" type="number" min="0" step="1">
  <select id="category"></select>
  <input id="newCategory" placeholder="Nueva categor√≠a (opcional)">
  <input id="discount" placeholder="Descuento (%)" type="number" min="0" max="100">
  
  <!-- Nueva √°rea de carga de im√°genes -->
  <div class="image-upload-area" id="uploadArea">
    <div class="upload-icon">üñºÔ∏è</div>
    <div class="upload-text">Arrastra y suelta im√°genes aqu√≠</div>
    <div class="upload-subtext">o haz clic para seleccionar archivos</div>
  </div>
  
  <input type="file" id="image" class="hidden-file-input" multiple accept="image/*">
  
  <div class="image-options">
    <label>O pega una URL:</label>
    <input type="url" id="imageUrl" class="url-input" placeholder="https://ejemplo.com/imagen.jpg">
    <button type="button" class="add-url-btn" id="addUrlBtn">Agregar URL</button>
  </div>
  
  <div id="imagePreviewContainer" class="image-preview-container"></div>
  
  <button id="actionBtn" class="add-btn">Agregar</button>
  <button id="cancelBtn" class="cancel-btn" style="display:none;">Cancelar</button>
</div>

<script>
// Funciones de utilidad para generar placeholders
function createPlaceholderSvg(width = 40, height = 40, text = 'IMG') {
    return `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`
        <svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
            <rect width="100%" height="100%" fill="#333"/>
            <rect width="100%" height="100%" fill="url(#gradient)" opacity="0.8"/>
            <defs>
                <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#444;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#222;stop-opacity:1" />
                </linearGradient>
            </defs>
            <text x="50%" y="50%" text-anchor="middle" dominant-baseline="central" 
                  fill="#999" font-family="Arial" font-size="${Math.min(width/4, 12)}" font-weight="bold">${text}</text>
        </svg>
    `)}`;
}

function createProductPlaceholder(productName = '', size = 40) {
    const initials = productName.split(' ')
        .map(word => word.trim()[0])
        .filter(letter => letter)
        .join('')
        .substring(0, 2)
        .toUpperCase() || 'P';
    
    const colors = ['#2196F3', '#4CAF50', '#FF9800', '#9C27B0', '#F44336', '#00BCD4'];
    const color = colors[productName.length % colors.length];
    
    return `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`
        <svg width="${size}" height="${size}" xmlns="http://www.w3.org/2000/svg">
            <circle cx="50%" cy="50%" r="45%" fill="${color}"/>
            <text x="50%" y="50%" text-anchor="middle" dominant-baseline="central" 
                  fill="white" font-family="Arial" font-size="${Math.min(size/2.5, 16)}" font-weight="bold">${initials}</text>
        </svg>
    `)}`;
}

// Sistema mejorado de manejo de im√°genes - SIN via.placeholder.com
class ImageManager {
    constructor() {
        this.retryCount = new Map();
        this.maxRetries = 1;
    }

    handleImageError(img, originalSrc, productName = '') {
        // Directamente usar placeholder sin intentar URLs externas problem√°ticas
        this.replaceWithPlaceholder(img, productName);
    }

    extractSizeFromUrl(url) {
        const match = url.match(/(\d+)/);
        return match ? parseInt(match[0]) : 40;
    }

    replaceWithPlaceholder(img, productName = '') {
        const size = img.width || img.height || 40;
        const placeholder = document.createElement('div');
        placeholder.className = 'no-image-placeholder';
        placeholder.style.width = size + 'px';
        placeholder.style.height = size + 'px';
        placeholder.textContent = productName ? 
            productName.substring(0, 2).toUpperCase() : 'IMG';
        
        if (img.parentNode) {
            img.parentNode.replaceChild(placeholder, img);
        }
    }

    loadImage(src, alt = '', className = '', productName = '') {
        return new Promise((resolve, reject) => {
            const img = document.createElement('img');
            img.alt = alt;
            img.className = className;
            
            img.onload = () => resolve(img);
            img.onerror = () => {
                this.handleImageError(img, src, productName);
                resolve(img); // Resolver aunque haya error, porque manejamos el fallback
            };
            
            img.src = src;
        });
    }
}

const imageManager = new ImageManager();

function logout(){
  fetch('/logout', { method: 'POST' }).then(() => window.location.href = '/login.html');
}

let products = [];
let categories = [];
let editId = null;
let currentImages = []; // Array para m√∫ltiples im√°genes
let csvData = []; // Datos del CSV cargado

// Configurar drag & drop para im√°genes
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('image');
const imageUrl = document.getElementById('imageUrl');
const addUrlBtn = document.getElementById('addUrlBtn');
const previewContainer = document.getElementById('imagePreviewContainer');

// Configurar importador CSV
const csvUploadArea = document.getElementById('csvUploadArea');
const csvFileInput = document.getElementById('csvFile');
const downloadTemplate = document.getElementById('downloadTemplate');
const importCsv = document.getElementById('importCsv');
const cancelImport = document.getElementById('cancelImport');
const csvPreview = document.getElementById('csvPreview');

// Eventos de drag & drop para im√°genes
uploadArea.addEventListener('click', () => fileInput.click());
uploadArea.addEventListener('dragover', handleDragOver);
uploadArea.addEventListener('dragleave', handleDragLeave);
uploadArea.addEventListener('drop', handleDrop);
fileInput.addEventListener('change', handleFileSelect);
addUrlBtn.addEventListener('click', addImageUrl);

// Eventos para importador CSV
csvUploadArea.addEventListener('click', () => csvFileInput.click());
csvUploadArea.addEventListener('dragover', handleCsvDragOver);
csvUploadArea.addEventListener('dragleave', handleCsvDragLeave);
csvUploadArea.addEventListener('drop', handleCsvDrop);
csvFileInput.addEventListener('change', handleCsvFileSelect);
downloadTemplate.addEventListener('click', downloadCsvTemplate);
importCsv.addEventListener('click', importCsvData);
cancelImport.addEventListener('click', cancelCsvImport);

// Funci√≥n mejorada para manejar errores de imagen
function handleImageError(img, fallbackUrl = null, productName = '') {
    imageManager.handleImageError(img, img.src, productName);
}

function handleDragOver(e) {
    e.preventDefault();
    uploadArea.classList.add('drag-over');
}

function handleDragLeave(e) {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
}

function handleDrop(e) {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
    const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
    processFiles(files);
}

function handleFileSelect(e) {
    const files = Array.from(e.target.files);
    processFiles(files);
}

function processFiles(files) {
    files.forEach(file => {
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                addImageToPreview(e.target.result, 'file', file);
            };
            reader.readAsDataURL(file);
        }
    });
}

function addImageUrl() {
    const url = imageUrl.value.trim();
    if (url && isValidImageUrl(url)) {
        addImageToPreview(url, 'url');
        imageUrl.value = '';
    } else {
        alert('Por favor, ingresa una URL v√°lida de imagen');
    }
}

function isValidImageUrl(url) {
    try {
        new URL(url);
        return /\.(jpg|jpeg|png|gif|webp|svg)(\?|$)/i.test(url) || 
               url.includes('unsplash') || 
               url.includes('imgur') ||
               url.includes('picsum') ||
               url.includes('images.unsplash') ||
               url.startsWith('data:image/') ||
               url.startsWith('/') || // URLs relativas
               url.includes('cloudinary') ||
               url.includes('amazonaws');
    } catch {
        return false;
    }
}

function addImageToPreview(src, type, file = null) {
    const imageData = {
        src: src,
        type: type,
        file: file,
        id: Date.now() + Math.random()
    };
    
    currentImages.push(imageData);
    renderImagePreviews();
}

function removeImage(imageId) {
    currentImages = currentImages.filter(img => img.id !== imageId);
    renderImagePreviews();
}

function renderImagePreviews() {
    previewContainer.innerHTML = '';
    currentImages.forEach(imageData => {
        const imageItem = document.createElement('div');
        imageItem.className = 'image-item';
        
        const img = document.createElement('img');
        img.src = imageData.src;
        img.alt = 'Preview';
        img.onerror = () => handleImageError(img, null, 'Preview');
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-image';
        removeBtn.innerHTML = '&times;';
        removeBtn.onclick = () => removeImage(imageData.id);
        
        imageItem.appendChild(img);
        imageItem.appendChild(removeBtn);
        previewContainer.appendChild(imageItem);
    });
}

async function loadFromServer(){
  try {
    const res = await fetch('/api/data');
    const data = await res.json();
    products = data.products || [];
    categories = data.categories?.map(c => c.name) || [];
    render();
    fillCategories();
  } catch (error) {
    console.error('Error cargando datos:', error);
    showMessage('Error al cargar los datos del servidor', 'error');
  }
}

function fillCategories(){
  const sel = document.getElementById('category');
  sel.innerHTML = '<option value="">Seleccionar categor√≠a</option>';
  categories.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    sel.appendChild(opt);
  });
}

function render(){
  const list = document.getElementById('list');
  list.innerHTML = '';
  
  products.forEach((p,i) => {
    const hasImages = p.images && p.images.length > 0;
    const imageUrl = hasImages ? p.images[0] : createProductPlaceholder(p.name, 40);
    const discountTxt = p.discount ? ` (${p.discount}% desc.)` : '';
    const stockTxt = p.stock !== undefined ? ` - Stock: ${p.stock}` : '';
    
    const productDiv = document.createElement('div');
    productDiv.className = 'product';
    
    const img = document.createElement('img');
    img.src = imageUrl;
    img.alt = p.name;
    img.onerror = () => handleImageError(img, null, p.name);
    
    const span = document.createElement('span');
    span.appendChild(img);
    span.appendChild(document.createTextNode(`${p.name} - S/.${p.price}${discountTxt}${stockTxt}`));
    
    const buttonDiv = document.createElement('div');
    buttonDiv.innerHTML = `
        <button class="edit-btn" onclick="edit(${i})">Editar</button>
        <button class="delete-btn" onclick="del(${i})">Eliminar</button>
    `;
    
    productDiv.appendChild(span);
    productDiv.appendChild(buttonDiv);
    list.appendChild(productDiv);
  });
}

function showMessage(message, type = 'info') {
    const messageDiv = document.createElement('div');
    messageDiv.className = `${type}-message`;
    messageDiv.textContent = message;
    
    const container = document.querySelector('.container');
    container.insertBefore(messageDiv, container.firstChild);
    
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
        }
    }, 5000);
}

function del(i){
  if (confirm('¬øEst√°s seguro de que quieres eliminar este producto?')) {
    products.splice(i,1);
    saveToServer();
    render();
    showMessage('Producto eliminado correctamente', 'success');
  }
}

function edit(i){
  const p = products[i];
  editId = p.id;
  document.getElementById('name').value = p.name;
  document.getElementById('shortDesc').value = p.shortDesc || '';
  document.getElementById('price').value = p.price;
  document.getElementById('stock').value = p.stock !== undefined ? p.stock : 0;
  document.getElementById('category').value = p.category || '';
  document.getElementById('discount').value = p.discount || '';
  
  // Cargar im√°genes existentes
  currentImages = [];
  if (p.images && p.images.length) {
    p.images.forEach((imgUrl, index) => {
      addImageToPreview(imgUrl, 'url');
    });
  }
  
  document.getElementById('form-title').textContent = 'Editar producto';
  document.getElementById('actionBtn').textContent = 'Guardar cambios';
  document.getElementById('actionBtn').className = 'save-btn';
  document.getElementById('cancelBtn').style.display = 'inline-block';
}

document.getElementById('cancelBtn').onclick = () => resetForm();

function resetForm(){
  editId = null;
  currentImages = [];
  document.getElementById('name').value = '';
  document.getElementById('shortDesc').value = '';
  document.getElementById('price').value = '';
  document.getElementById('stock').value = '';
  document.getElementById('newCategory').value = '';
  document.getElementById('discount').value = '';
  document.getElementById('image').value = '';
  document.getElementById('imageUrl').value = '';
  renderImagePreviews();
  document.getElementById('form-title').textContent = 'Agregar producto';
  document.getElementById('actionBtn').textContent = 'Agregar';
  document.getElementById('actionBtn').className = 'add-btn';
  document.getElementById('cancelBtn').style.display = 'none';
}

document.getElementById('actionBtn').onclick = async () => {
  const name = document.getElementById('name').value.trim();
  const shortDesc = document.getElementById('shortDesc').value.trim();
  const price = parseFloat(document.getElementById('price').value);
  const stock = parseInt(document.getElementById('stock').value) || 0;
  let category = document.getElementById('category').value;
  const newCategory = document.getElementById('newCategory').value.trim();
  
  if(newCategory){
    if (!categories.includes(newCategory)) {
      categories.push(newCategory);
      category = newCategory;
      fillCategories();
    }
  }
  
  const discount = parseInt(document.getElementById('discount').value) || null;

  if(!name || isNaN(price)) {
    showMessage('Por favor, completa el nombre y precio del producto', 'error');
    return;
  }

  if (price <= 0) {
    showMessage('El precio debe ser mayor a 0', 'error');
    return;
  }

  // Procesar im√°genes
  let finalImages = [];
  
  try {
    const actionBtn = document.getElementById('actionBtn');
    const originalText = actionBtn.textContent;
    actionBtn.textContent = 'Procesando...';
    actionBtn.disabled = true;
    
    for (const imageData of currentImages) {
      if (imageData.type === 'file' && imageData.file) {
        // Subir archivo
        const formData = new FormData();
        formData.append('images', imageData.file);
        try {
          const uploadRes = await fetch('/api/upload', { method: 'POST', body: formData });
          const uploadData = await uploadRes.json();
          if (uploadData.urls && uploadData.urls[0]) {
            finalImages.push(uploadData.urls[0]);
          }
        } catch (uploadError) {
          console.warn('Error subiendo imagen:', uploadError);
          finalImages.push(imageData.src);
        }
      } else if (imageData.type === 'url') {
        finalImages.push(imageData.src);
      }
    }

    const productData = {
      id: editId || Date.now(),
      name,
      shortDesc,
      price,
      stock,
      category,
      discount,
      images: finalImages
    };

    if(editId){
      try {
        await fetch(`/api/products/${editId}`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(productData)
        });
      } catch (error) {
        console.warn('Error en API, actualizando localmente:', error);
      }
      
      const idx = products.findIndex(p => p.id === editId);
      if (idx !== -1) {
        products[idx] = productData;
      }
    } else {
      products.push(productData);
    }

    await saveToServer();
    render();
    resetForm();
    showMessage(editId ? 'Producto actualizado correctamente' : 'Producto agregado correctamente', 'success');
    
  } catch (error) {
    console.error('Error procesando producto:', error);
    showMessage('Error al procesar el producto. Int√©ntalo de nuevo.', 'error');
  } finally {
    const actionBtn = document.getElementById('actionBtn');
    actionBtn.textContent = editId ? 'Guardar cambios' : 'Agregar';
    actionBtn.disabled = false;
  }
};

async function saveToServer(){
  try {
    const res = await fetch('/api/data');
    let data = await res.json();
    data.products = products;
    data.categories = categories.map((name, i) => ({id: i+1, name, label: name}));
    
    await fetch('/api/saveAll', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });
  } catch (error) {
    console.error('Error guardando en servidor:', error);
    showMessage('Error al guardar los cambios en el servidor', 'error');
  }
}

// Prevenir comportamiento por defecto del navegador para drag & drop
window.addEventListener('dragover', e => e.preventDefault());
window.addEventListener('drop', e => e.preventDefault());

// ===== FUNCIONES PARA IMPORTADOR CSV =====

function handleCsvDragOver(e) {
    e.preventDefault();
    csvUploadArea.classList.add('drag-over');
}

function handleCsvDragLeave(e) {
    e.preventDefault();
    csvUploadArea.classList.remove('drag-over');
}

function handleCsvDrop(e) {
    e.preventDefault();
    csvUploadArea.classList.remove('drag-over');
    const files = Array.from(e.dataTransfer.files).filter(file => 
        file.type === 'text/csv' || file.name.endsWith('.csv') || file.type === 'text/plain'
    );
    if (files.length > 0) {
        processCsvFile(files[0]);
    }
}

function handleCsvFileSelect(e) {
    const file = e.target.files[0];
    if (file) {
        processCsvFile(file);
    }
}

function processCsvFile(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const csvContent = e.target.result;
        parseCsvContent(csvContent);
    };
    reader.readAsText(file, 'UTF-8');
}

function parseCsvContent(csvContent) {
    try {
        const lines = csvContent.trim().split('\n');
        if (lines.length < 2) {
            showMessage('El archivo CSV debe tener al menos una fila de encabezados y una fila de datos', 'error');
            return;
        }

        const separator = lines[0].includes(';') ? ';' : ',';
        const headers = lines[0].split(separator).map(h => h.trim().replace(/"/g, ''));
        
        const data = [];
        for (let i = 1; i < lines.length; i++) {
            if (lines[i].trim()) {
                const values = parseCsvLine(lines[i], separator);
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                data.push(row);
            }
        }

        csvData = data;
        showCsvPreview(headers, data);
        
    } catch (error) {
        console.error('Error parsing CSV:', error);
        showMessage('Error al procesar el archivo CSV. Aseg√∫rate de que est√© en el formato correcto.', 'error');
    }
}

function parseCsvLine(line, separator) {
    const values = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === separator && !inQuotes) {
            values.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }
    
    values.push(current.trim());
    return values.map(v => v.replace(/"/g, ''));
}

function showCsvPreview(headers, data) {
    const table = document.getElementById('csvPreviewTable');
    const stats = document.getElementById('csvStats');
    
    table.innerHTML = '';
    
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    const tbody = document.createElement('tbody');
    const previewData = data.slice(0, 5);
    previewData.forEach(row => {
        const tr = document.createElement('tr');
        headers.forEach(header => {
            const td = document.createElement('td');
            td.textContent = row[header] || '';
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    
    stats.textContent = `Total de productos a importar: ${data.length}`;
    
    csvPreview.style.display = 'block';
    importCsv.style.display = 'inline-block';
    cancelImport.style.display = 'inline-block';
}

function downloadCsvTemplate() {
    const template = `nombre,descripcion,precio,stock,categoria,descuento,imagen_url
"Producto Ejemplo 1","Descripci√≥n del producto 1",29.99,10,"Electr√≥nicos",15,"https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=200&h=200&fit=crop"
"Producto Ejemplo 2","Descripci√≥n del producto 2",45.50,5,"Ropa",0,"https://images.unsplash.com/photo-1441986300917-64674bd600d8?w=200&h=200&fit=crop"
"Producto Ejemplo 3","Descripci√≥n del producto 3",12.99,20,"Hogar",10,"https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=200&h=200&fit=crop"`;

    const blob = new Blob([template], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'plantilla_productos.csv';
    link.click();
}

async function importCsvData() {
    if (!csvData || csvData.length === 0) {
        showMessage('No hay datos para importar', 'error');
        return;
    }

    const confirmMsg = `¬øEst√°s seguro de importar ${csvData.length} productos? Esta acci√≥n agregar√° todos los productos a tu cat√°logo.`;
    if (!confirm(confirmMsg)) {
        return;
    }

    const importBtn = importCsv;
    const originalText = importBtn.textContent;
    importBtn.textContent = 'Importando...';
    importBtn.disabled = true;

    try {
        let importedCount = 0;
        let errorCount = 0;
        const errors = [];

        for (let i = 0; i < csvData.length; i++) {
            const row = csvData[i];
            
            try {
                const name = row.nombre || row.name || '';
                const shortDesc = row.descripcion || row.description || row.desc || '';
                const price = parseFloat(row.precio || row.price || 0);
                const stock = parseInt(row.stock || row.cantidad || 0);
                const category = row.categoria || row.category || '';
                const discount = parseInt(row.descuento || row.discount || 0);
                const imageUrl = row.imagen_url || row.image_url || row.imagen || row.image || '';

                if (!name.trim()) {
                    errors.push(`Fila ${i + 2}: Falta el nombre del producto`);
                    errorCount++;
                    continue;
                }

                if (isNaN(price) || price <= 0) {
                    errors.push(`Fila ${i + 2}: Precio inv√°lido (${row.precio || row.price})`);
                    errorCount++;
                    continue;
                }

                const productData = {
                    id: Date.now() + i,
                    name: name.trim(),
                    shortDesc: shortDesc.trim(),
                    price: price,
                    stock: stock || 0,
                    category: category.trim(),
                    discount: (discount > 0 && discount <= 100) ? discount : null,
                    images: imageUrl.trim() ? [imageUrl.trim()] : []
                };

                if (category.trim() && !categories.includes(category.trim())) {
                    categories.push(category.trim());
                }

                products.push(productData);
                importedCount++;

            } catch (error) {
                errors.push(`Fila ${i + 2}: Error procesando producto - ${error.message}`);
                errorCount++;
            }
        }

        await saveToServer();
        render();
        fillCategories();
        cancelCsvImport();

        let message = `Importaci√≥n completada:\n‚úÖ ${importedCount} productos importados`;
        if (errorCount > 0) {
            message += `\n‚ùå ${errorCount} errores`;
            if (errors.length <= 5) {
                message += `\n\nErrores:\n${errors.join('\n')}`;
            } else {
                message += `\n\nPrimeros errores:\n${errors.slice(0, 5).join('\n')}\n... y ${errors.length - 5} m√°s`;
            }
        }
        
        alert(message);
        showMessage(`Importaci√≥n completada: ${importedCount} productos agregados`, 'success');

    } catch (error) {
        console.error('Error importando CSV:', error);
        showMessage('Error durante la importaci√≥n. Por favor, int√©ntalo de nuevo.', 'error');
    } finally {
        importBtn.textContent = originalText;
        importBtn.disabled = false;
    }
}

function cancelCsvImport() {
    csvData = [];
    csvPreview.style.display = 'none';
    importCsv.style.display = 'none';
    cancelImport.style.display = 'none';
    csvFileInput.value = '';
}

// Auto-reparaci√≥n de im√°genes rotas al cargar la p√°gina
function fixBrokenImages() {
    // Buscar y reemplazar todas las im√°genes que contengan via.placeholder.com
    const brokenImages = document.querySelectorAll('img[src*="via.placeholder"]');
    brokenImages.forEach(img => {
        const productName = img.alt || '';
        const size = img.width || img.height || 40;
        img.src = createProductPlaceholder(productName, size);
    });
    
    // Tambi√©n verificar im√°genes que no cargan
    const allImages = document.querySelectorAll('img');
    allImages.forEach(img => {
        if (img.src.includes('via.placeholder')) {
            const productName = img.alt || '';
            const size = img.width || img.height || 40;
            img.src = createProductPlaceholder(productName, size);
        }
    });
}

// Interceptar cualquier intento de cargar via.placeholder.com
function interceptPlaceholderRequests() {
    const originalCreateElement = document.createElement;
    document.createElement = function(tagName) {
        const element = originalCreateElement.call(document, tagName);
        if (tagName.toLowerCase() === 'img') {
            const originalSetSrc = Object.getOwnPropertyDescriptor(HTMLImageElement.prototype, 'src').set;
            Object.defineProperty(element, 'src', {
                set: function(value) {
                    if (typeof value === 'string' && value.includes('via.placeholder')) {
                        const size = value.match(/(\d+)/g);
                        const width = size ? size[0] : 40;
                        const height = size && size[1] ? size[1] : width;
                        const altText = this.alt || '';
                        originalSetSrc.call(this, createProductPlaceholder(altText, width));
                    } else {
                        originalSetSrc.call(this, value);
                    }
                },
                get: function() {
                    return Object.getOwnPropertyDescriptor(HTMLImageElement.prototype, 'src').get.call(this);
                }
            });
        }
        return element;
    };
}

// Inicializar la aplicaci√≥n
document.addEventListener('DOMContentLoaded', function() {
    // Interceptar requests de placeholder ANTES de cualquier cosa
    interceptPlaceholderRequests();
    
    // Arreglar im√°genes rotas existentes
    fixBrokenImages();
    
    // Cargar datos del servidor
    loadFromServer();
    
    // Observar cambios en el DOM para interceptar nuevas im√°genes
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === 1) { // Element node
                    const images = node.tagName === 'IMG' ? [node] : 
                                  node.querySelectorAll ? Array.from(node.querySelectorAll('img')) : [];
                    
                    images.forEach(img => {
                        if (img.src && img.src.includes('via.placeholder')) {
                            const productName = img.alt || '';
                            const size = img.width || img.height || 40;
                            img.src = createProductPlaceholder(productName, size);
                        }
                    });
                }
            });
        });
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
});

// Prevenir cualquier carga de via.placeholder.com a nivel global
window.addEventListener('beforeunload', function() {
    // Limpiar cualquier imagen problem√°tica antes de salir
    const brokenImages = document.querySelectorAll('img[src*="via.placeholder"]');
    brokenImages.forEach(img => {
        img.src = createPlaceholderSvg(40, 40, 'IMG');
    });
});

// Hacer las funciones globales para que puedan ser llamadas desde el HTML
window.handleImageError = handleImageError;
window.removeImage = removeImage;
window.edit = edit;
window.del = del;
window.logout = logout;
</script>
</body>
</html>