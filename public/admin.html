<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Admin - Hern√°ndezStore</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root { 
            --accent:#f5c542; 
            --bg:#0a0a0a; 
            --panel:#1a1a1a; 
            --panel2:#222; 
            --panel3:#333;
            --text:#fff; 
            --muted:#ccc; 
            --ok:#28a745; 
            --danger:#dc3545; 
            --warning:#ffc107; 
            --info:#17a2b8;
        }
        
        * { box-sizing: border-box; }
        
        body { 
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--panel), var(--panel2));
            padding: 1.5rem 2rem;
            border-bottom: 2px solid var(--accent);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .header h1 {
            margin: 0;
            color: var(--accent);
            font-size: 2rem;
            font-weight: bold;
        }
        
        .header .subtitle {
            color: var(--muted);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        .header .actions {
            position: absolute;
            top: 1.5rem;
            right: 2rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-top: 2rem;
            border-bottom: 2px solid var(--panel3);
        }

        .tab-button {
            padding: 1rem 2rem;
            background: var(--panel2);
            border: none;
            color: var(--muted);
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-button:hover {
            background: var(--panel3);
            color: var(--text);
        }

        .tab-button.active {
            background: var(--panel);
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
        
        /* Container principal */
        .container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            padding: 2rem;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        /* Panel izquierdo */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        /* Panel derecho */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        /* Cards base */
        .card {
            background: var(--panel);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--panel3);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }
        
        .card h3 {
            margin: 0 0 1rem 0;
            color: var(--accent);
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Formulario de producto */
        .product-form {
            display: grid;
            gap: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        label {
            font-weight: 600;
            color: var(--text);
            font-size: 0.9rem;
        }
        
        input, select, textarea {
            padding: 0.8rem;
            border: 2px solid var(--panel3);
            border-radius: 8px;
            background: var(--panel2);
            color: var(--text);
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(245, 197, 66, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        /* √Årea de drag & drop */
        .upload-area {
            border: 2px dashed var(--panel3);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            background: var(--panel2);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .upload-area:hover {
            border-color: var(--accent);
            background: rgba(245, 197, 66, 0.05);
        }
        
        .upload-area.dragover {
            border-color: var(--accent);
            background: rgba(245, 197, 66, 0.1);
            transform: scale(1.02);
        }
        
        .upload-area .upload-icon {
            font-size: 3rem;
            color: var(--muted);
            margin-bottom: 1rem;
        }
        
        .upload-area.dragover .upload-icon {
            color: var(--accent);
        }
        
        .upload-text {
            color: var(--muted);
            font-size: 1rem;
        }
        
        .upload-text strong {
            color: var(--accent);
        }
        
        .file-input {
            display: none;
        }
        
        /* Preview de im√°genes */
        .image-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--panel3);
            background: var(--panel3);
        }
        
        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .preview-item .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--danger);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .preview-item:hover .remove-btn {
            opacity: 1;
        }
        
        /* Botones */
        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            text-align: center;
            justify-content: center;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .btn-primary {
            background: var(--accent);
            color: #000;
        }
        
        .btn-success {
            background: var(--ok);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-secondary {
            background: var(--panel3);
            color: var(--text);
        }
        
        .btn-info {
            background: var(--info);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        /* Lista de productos */
        .product-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: 600px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }
        
        .product-item {
            background: var(--panel2);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid var(--panel3);
            transition: all 0.2s ease;
        }
        
        .product-item:hover {
            border-color: var(--accent);
            transform: translateX(4px);
        }
        
        .product-item.editing {
            border-color: var(--info);
            background: rgba(23, 162, 184, 0.1);
        }
        
        .product-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .product-name {
            font-weight: 600;
            color: var(--text);
            font-size: 1.1rem;
        }
        
        .product-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .product-details {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 1rem;
            align-items: center;
        }
        
        .product-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid var(--panel3);
        }
        
        .product-info {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }
        
        .product-price {
            font-weight: bold;
            color: var(--accent);
            font-size: 1.2rem;
        }
        
        .product-meta {
            color: var(--muted);
            font-size: 0.85rem;
        }
        
        .stock-badge {
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .stock-high {
            background: var(--ok);
            color: white;
        }
        
        .stock-low {
            background: var(--warning);
            color: black;
        }
        
        .stock-out {
            background: var(--danger);
            color: white;
        }

        /* Category list */
        .category-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .category-item {
            background: var(--panel2);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid var(--panel3);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .category-item:hover {
            border-color: var(--accent);
            transform: translateX(4px);
        }

        .category-item.editing {
            border-color: var(--info);
            background: rgba(23, 162, 184, 0.1);
        }

        .category-info {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .category-name {
            font-weight: 600;
            color: var(--text);
            font-size: 1.1rem;
        }

        .category-internal {
            color: var(--muted);
            font-size: 0.85rem;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            backdrop-filter: blur(10px);
        }
        
        .modal-overlay.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .modal {
            background: var(--panel);
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid var(--accent);
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: slideUp 0.3s ease;
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--panel3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            color: var(--accent);
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--muted);
            font-size: 1.5rem;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: var(--danger);
            color: white;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--panel3);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        
        /* Estad√≠sticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--panel2);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--panel3);
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent);
            display: block;
        }
        
        .stat-label {
            color: var(--muted);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        /* Alertas */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid;
            animation: slideIn 0.3s ease;
        }
        
        .alert-success {
            background: rgba(40, 167, 69, 0.1);
            border-color: var(--ok);
            color: var(--ok);
        }
        
        .alert-danger {
            background: rgba(220, 53, 69, 0.1);
            border-color: var(--danger);
            color: var(--danger);
        }
        
        .alert-warning {
            background: rgba(255, 193, 7, 0.1);
            border-color: var(--warning);
            color: var(--warning);
        }
        
        .alert-info {
            background: rgba(23, 162, 184, 0.1);
            border-color: var(--info);
            color: var(--info);
        }
        
        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--panel3);
            border-radius: 50%;
            border-top: 2px solid var(--accent);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
                gap: 1.5rem;
                padding: 1rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .header .actions {
                position: relative;
                top: auto;
                right: auto;
                margin-top: 1rem;
            }
            
            .product-details {
                grid-template-columns: 1fr;
                gap: 0.5rem;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
                gap: 0;
            }

            .tab-button {
                border-radius: 0;
                border-bottom: 1px solid var(--panel3);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>üè™ Panel Admin - Hern√°ndezStore</h1>
        <div class="subtitle">Gesti√≥n avanzada de productos e inventario</div>
        <div class="actions">
            <a href="/" class="btn btn-secondary">üè† Ver Tienda</a>
        </div>
    </div>

    <!-- Alertas -->
    <div id="alerts-container"></div>

    <!-- Estad√≠sticas -->
    <div class="stats-grid" style="padding: 2rem 2rem 0;">
        <div class="stat-card">
            <span class="stat-number" id="totalProducts">0</span>
            <div class="stat-label">Total Productos</div>
        </div>
        <div class="stat-card">
            <span class="stat-number" id="totalStock">0</span>
            <div class="stat-label">Stock Total</div>
        </div>
        <div class="stat-card">
            <span class="stat-number" id="lowStockCount">0</span>
            <div class="stat-label">Stock Bajo</div>
        </div>
        <div class="stat-card">
            <span class="stat-number" id="categoriesCount">0</span>
            <div class="stat-label">Categor√≠as</div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs" style="padding: 0 2rem;">
        <button class="tab-button active" onclick="switchTab('products', this)">üì¶ Productos</button>
        <button class="tab-button" onclick="switchTab('categories', this)">üè∑Ô∏è Categor√≠as</button>
    </div>

    <!-- Tab Content: Products -->
    <div id="products-tab" class="tab-content active">
        <div class="container">
            <!-- Panel izquierdo - Formulario -->
            <div class="left-panel">
                <div class="card">
                    <h3>
                        <span id="formTitle">‚ûï Crear Producto</span>
                        <button id="cancelEdit" class="btn btn-secondary" style="margin-left: auto; display: none;">
                            ‚ùå Cancelar
                        </button>
                    </h3>
                    
                    <form id="productForm" class="product-form">
                        <input type="hidden" id="productId" name="productId">
                        
                        <div class="form-group">
                            <label for="productName">Nombre del producto *</label>
                            <input type="text" id="productName" name="name" required placeholder="Ej: iPhone 14 Pro">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="productPrice">Precio (S/.) *</label>
                                <input type="number" id="productPrice" name="price" step="0.01" required placeholder="0.00">
                            </div>
                            <div class="form-group">
                                <label for="productStock">Stock *</label>
                                <input type="number" id="productStock" name="stock" min="0" required placeholder="0">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="productCategory">Categor√≠a</label>
                                <select id="productCategory" name="category">
                                    <option value="">Seleccionar categor√≠a</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="productDiscount">Descuento (%)</label>
                                <input type="number" id="productDiscount" name="discount" min="0" max="100" placeholder="0">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="productDescription">Descripci√≥n</label>
                            <textarea id="productDescription" name="shortDesc" placeholder="Descripci√≥n detallada del producto..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Im√°genes del producto</label>
                            <div class="upload-area" id="uploadArea">
                                <div class="upload-icon">üì∏</div>
                                <div class="upload-text">
                                    <strong>Arrastra im√°genes aqu√≠</strong><br>
                                    o haz clic para seleccionar
                                </div>
                                <input type="file" id="fileInput" class="file-input" multiple accept="image/*">
                            </div>
                            <div class="image-preview" id="imagePreview"></div>
                        </div>
                        
                        <button type="submit" class="btn btn-success" id="submitBtn">
                            <span id="submitText">üíæ Guardar Producto</span>
                            <span id="submitLoader" class="loading" style="display: none;"></span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Panel derecho - Lista de productos -->
            <div class="right-panel">
                <div class="card">
                    <h3>üì¶ Productos en inventario</h3>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <input type="text" id="searchProducts" placeholder="üîç Buscar productos..." style="width: 100%;">
                    </div>
                    
                    <div id="productsList" class="product-list">
                        <div style="text-align: center; padding: 2rem; color: var(--muted);">
                            <div class="loading"></div>
                            <p style="margin-top: 1rem;">Cargando productos...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content: Categories -->
    <div id="categories-tab" class="tab-content">
        <div class="container">
            <div class="left-panel">
                <div class="card">
                    <h3>
                        <span id="categoryFormTitle">‚ûï Crear Categor√≠a</span>
                        <button id="cancelCategoryEdit" class="btn btn-secondary" style="margin-left: auto; display: none;">
                            ‚ùå Cancelar
                        </button>
                    </h3>
                    <form id="categoryForm" class="product-form">
                        <input type="hidden" id="categoryId" name="categoryId">
                        <div class="form-group">
                            <label for="categoryName">Nombre interno *</label>
                            <input type="text" id="categoryName" name="name" required placeholder="ej: electronics">
                        </div>
                        <div class="form-group">
                            <label for="categoryLabel">Nombre visible *</label>
                            <input type="text" id="categoryLabel" name="label" required placeholder="ej: Electr√≥nicos">
                        </div>
                        <button type="submit" class="btn btn-success" id="categorySubmitBtn">
                            <span id="categorySubmitText">üíæ Guardar Categor√≠a</span>
                            <span id="categorySubmitLoader" class="loading" style="display: none;"></span>
                        </button>
                    </form>
                </div>
            </div>
            <div class="right-panel">
                <div class="card">
                    <h3>üè∑Ô∏è Categor√≠as disponibles</h3>
                    <div id="categoriesList" class="category-list">
                        <div style="text-align: center; padding: 2rem; color: var(--muted);">
                            <div class="loading"></div>
                            <p style="margin-top: 1rem;">Cargando categor√≠as...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmaci√≥n para productos -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <h3>üóëÔ∏è Confirmar eliminaci√≥n</h3>
                <button class="modal-close" onclick="closeDeleteModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p>¬øEst√°s seguro de que deseas eliminar este producto?</p>
                <div id="deleteProductInfo" style="background: var(--panel2); padding: 1rem; border-radius: 8px; margin: 1rem 0;"></div>
                <p style="color: var(--danger); font-size: 0.9rem;">‚ö†Ô∏è Esta acci√≥n no se puede deshacer</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancelar</button>
                <button class="btn btn-danger" onclick="confirmDelete()">üóëÔ∏è Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Modal de confirmaci√≥n para categor√≠as -->
    <div class="modal-overlay" id="deleteCategoryModal">
        <div class="modal">
            <div class="modal-header">
                <h3>üóëÔ∏è Confirmar eliminaci√≥n de categor√≠a</h3>
                <button class="modal-close" onclick="closeDeleteCategoryModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p>¬øEst√°s seguro de que deseas eliminar esta categor√≠a?</p>
                <div id="deleteCategoryInfo" style="background: var(--panel2); padding: 1rem; border-radius: 8px; margin: 1rem 0;"></div>
                <p style="color: var(--danger); font-size: 0.9rem;">‚ö†Ô∏è Esta acci√≥n no se puede deshacer</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteCategoryModal()">Cancelar</button>
                <button class="btn btn-danger" onclick="confirmDeleteCategory()">üóëÔ∏è Eliminar</button>
            </div>
        </div>
    </div>

    <script>
        // ================================
        // VARIABLES GLOBALES
        // ================================
        let allProducts = [];
        let allCategories = [];
        let uploadedImages = [];
        let editingProductId = null;
        let editingCategoryId = null;
        let productToDelete = null;
        let categoryToDelete = null;

        // ================================
        // INICIALIZACI√ìN
        // ================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando panel admin...');
            setupEventListeners();
            loadData();
        });

        // ================================
        // TABS FUNCTIONALITY
        // ================================
        function switchTab(tabName, button) {
            // Ocultar todos los contenidos de pesta√±as
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Desactivar todos los botones de pesta√±as
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Mostrar el contenido de la pesta√±a seleccionada
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Activar el bot√≥n seleccionado
            button.classList.add('active');

            // Si se cambia a categor√≠as, cargar/renderizar categor√≠as
            if (tabName === 'categories') {
                renderCategories();
            }
        }

        // ================================
        // EVENT LISTENERS
        // ================================
        function setupEventListeners() {
            // Drag & Drop para productos
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });

            uploadArea.addEventListener('drop', handleDrop, false);
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);

            // Formularios
            document.getElementById('productForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('categoryForm').addEventListener('submit', handleCategoryFormSubmit);
            document.getElementById('cancelEdit').addEventListener('click', cancelEdit);
            document.getElementById('cancelCategoryEdit').addEventListener('click', cancelCategoryEdit);

            // B√∫squeda
            document.getElementById('searchProducts').addEventListener('input', debounce(handleSearch, 300));

            // Cerrar modales con ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeDeleteModal();
                    closeDeleteCategoryModal();
                    if (editingProductId) cancelEdit();
                    if (editingCategoryId) cancelCategoryEdit();
                }
            });
        }

        // ================================
        // DRAG & DROP
        // ================================
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight(e) {
            document.getElementById('uploadArea').classList.add('dragover');
        }

        function unhighlight(e) {
            document.getElementById('uploadArea').classList.remove('dragover');
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        async function handleFiles(files) {
            console.log(`üìÅ Procesando ${files.length} archivo(s)...`);
            
            const validFiles = Array.from(files).filter(file => {
                if (!file.type.startsWith('image/')) {
                    showAlert('Solo se permiten archivos de imagen', 'warning');
                    return false;
                }
                if (file.size > 5 * 1024 * 1024) { // 5MB max
                    showAlert(`El archivo ${file.name} es muy grande (m√°x 5MB)`, 'warning');
                    return false;
                }
                return true;
            });

            if (validFiles.length === 0) return;

            // Mostrar preview inmediato
            validFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    addImagePreview(e.target.result, file.name, true);
                };
                reader.readAsDataURL(file);
            });

            // Subir archivos
            try {
                const formData = new FormData();
                validFiles.forEach(file => formData.append('images', file));

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success) {
                    // Actualizar previews con URLs reales
                    const previews = document.querySelectorAll('.preview-item[data-temp="true"]');
                    result.urls.forEach((url, index) => {
                        if (previews[index]) {
                            previews[index].dataset.temp = 'false';
                            previews[index].dataset.url = url;
                        }
                        uploadedImages.push(url);
                    });

                    showAlert(`‚úÖ ${validFiles.length} imagen(es) subida(s) correctamente`, 'success');
                } else {
                    throw new Error(result.message || 'Error al subir im√°genes');
                }
            } catch (error) {
                console.error('‚ùå Error subiendo im√°genes:', error);
                showAlert('Error al subir im√°genes: ' + error.message, 'danger');
                
                // Remover previews temporales
                document.querySelectorAll('.preview-item[data-temp="true"]').forEach(item => item.remove());
            }
        }

        function addImagePreview(src, name, isTemp = false) {
            const preview = document.getElementById('imagePreview');
            const item = document.createElement('div');
            item.className = 'preview-item';
            item.dataset.temp = isTemp;
            
            if (!isTemp) {
                item.dataset.url = src;
            }

            item.innerHTML = `
                <img src="${src}" alt="${name}" title="${name}">
                <button type="button" class="remove-btn" onclick="removeImage(this)">√ó</button>
            `;

            preview.appendChild(item);
        }

        function removeImage(button) {
            const item = button.parentElement;
            const url = item.dataset.url;
            
            if (url && !item.dataset.temp) {
                uploadedImages = uploadedImages.filter(img => img !== url);
            }
            
            item.remove();
        }

        // ================================
        // DATOS Y API
        // ================================
        async function loadData() {
            try {
                console.log('üì° Cargando datos...');
                const response = await fetch('/api/data');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();

                allProducts = data.products || [];
                allCategories = data.categoriesData || [];

                console.log(`‚úÖ ${allProducts.length} productos cargados`);
                console.log(`üè∑Ô∏è ${allCategories.length} categor√≠as cargadas`);

                updateStats();
                populateCategories();
                renderProducts();
                renderCategories();
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                showAlert('Error cargando datos del servidor: ' + error.message, 'danger');
                
                // Mostrar estado de error en la UI
                const productsList = document.getElementById('productsList');
                if (productsList) {
                    productsList.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--danger);">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                            <h3>Error al cargar datos</h3>
                            <p>No se pudieron cargar los productos</p>
                            <button onclick="loadData()" class="btn btn-primary" style="margin-top: 1rem;">
                                üîÑ Reintentar
                            </button>
                        </div>
                    `;
                }
            }
        }

        async function saveProduct(productData) {
            try {
                const url = editingProductId ? `/api/products/${editingProductId}` : '/api/products';
                const method = editingProductId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success) {
                    showAlert(`‚úÖ Producto ${editingProductId ? 'actualizado' : 'creado'} correctamente`, 'success');
                    loadData(); // Recargar datos
                    resetForm();
                    return true;
                } else {
                    throw new Error(result.message || 'Error al guardar producto');
                }
            } catch (error) {
                console.error('‚ùå Error guardando producto:', error);
                showAlert('Error al guardar producto: ' + error.message, 'danger');
                return false;
            }
        }

        async function deleteProduct(productId) {
            try {
                const response = await fetch(`/api/products/${productId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success) {
                    showAlert('‚úÖ Producto eliminado correctamente', 'success');
                    loadData();
                    return true;
                } else {
                    throw new Error(result.message || 'Error al eliminar producto');
                }
            } catch (error) {
                console.error('‚ùå Error eliminando producto:', error);
                showAlert('Error al eliminar producto: ' + error.message, 'danger');
                return false;
            }
        }

        // ================================
        // CATEGORIES API
        // ================================
        async function saveCategory(categoryData) {
            try {
                const url = editingCategoryId ? `/api/categories/${editingCategoryId}` : '/api/categories';
                const method = editingCategoryId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(categoryData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success) {
                    showAlert(`‚úÖ Categor√≠a ${editingCategoryId ? 'actualizada' : 'creada'} correctamente`, 'success');
                    loadData(); // Recargar datos
                    resetCategoryForm();
                    return true;
                } else {
                    throw new Error(result.message || 'Error al guardar categor√≠a');
                }
            } catch (error) {
                console.error('‚ùå Error guardando categor√≠a:', error);
                showAlert('Error al guardar categor√≠a: ' + error.message, 'danger');
                return false;
            }
        }

        async function deleteCategory(categoryId) {
            try {
                const response = await fetch(`/api/categories/${categoryId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success) {
                    showAlert('‚úÖ Categor√≠a eliminada correctamente', 'success');
                    loadData();
                    return true;
                } else {
                    throw new Error(result.message || 'Error al eliminar categor√≠a');
                }
            } catch (error) {
                console.error('‚ùå Error eliminando categor√≠a:', error);
                showAlert('Error al eliminar categor√≠a: ' + error.message, 'danger');
                return false;
            }
        }

        // ================================
        // UI Y RENDERIZADO
        // ================================
        function updateStats() {
            const totalProducts = allProducts.length;
            const totalStock = allProducts.reduce((sum, p) => sum + (p.stock || 0), 0);
            const lowStockCount = allProducts.filter(p => (p.stock || 0) <= 5).length;
            const categoriesCount = allCategories.length;

            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('totalStock').textContent = totalStock;
            document.getElementById('lowStockCount').textContent = lowStockCount;
            document.getElementById('categoriesCount').textContent = categoriesCount;
        }

        function populateCategories() {
            const select = document.getElementById('productCategory');
            select.innerHTML = '<option value="">Seleccionar categor√≠a</option>';

            allCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.label || category.name || category;
                option.textContent = category.label || category.name || category;
                select.appendChild(option);
            });

            // Agregar opci√≥n para nueva categor√≠a
            const newOption = document.createElement('option');
            newOption.value = '__new__';
            newOption.textContent = '+ Nueva categor√≠a';
            select.appendChild(newOption);

            // Event listener para nueva categor√≠a
            select.onchange = function(e) {
                if (e.target.value === '__new__') {
                    const newCategory = prompt('Ingrese el nombre de la nueva categor√≠a:');
                    if (newCategory && newCategory.trim()) {
                        const option = document.createElement('option');
                        option.value = newCategory.trim();
                        option.textContent = newCategory.trim();
                        select.insertBefore(option, select.lastElementChild);
                        select.value = newCategory.trim();
                    } else {
                        select.value = '';
                    }
                }
            };
        }

        function renderProducts(products = allProducts) {
            const container = document.getElementById('productsList');

            if (products.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--muted);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üì¶</div>
                        <p>No hay productos que mostrar</p>
                        ${allProducts.length === 0 ? '<p style="font-size: 0.9rem;">¬°Crea tu primer producto!</p>' : ''}
                    </div>
                `;
                return;
            }

            container.innerHTML = products.map(product => {
                const images = product.images ? (typeof product.images === 'string' ? JSON.parse(product.images) : product.images) : [];
                const mainImage = images.length > 0 ? images[0] : '/uploads/placeholder.jpg';
                const stockClass = product.stock <= 0 ? 'stock-out' : product.stock <= 5 ? 'stock-low' : 'stock-high';
                const stockText = product.stock <= 0 ? 'Agotado' : product.stock <= 5 ? `${product.stock} disponibles` : `${product.stock} en stock`;

                return `
                    <div class="product-item ${editingProductId === product.id ? 'editing' : ''}" data-id="${product.id}">
                        <div class="product-header">
                            <div class="product-name">${product.name}</div>
                            <div class="product-actions">
                                <button class="btn btn-info" onclick="editProduct(${product.id})" title="Editar">
                                    ‚úèÔ∏è
                                </button>
                                <button class="btn btn-danger" onclick="showDeleteModal(${product.id})" title="Eliminar">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        <div class="product-details">
                            <img src="${mainImage}" alt="${product.name}" class="product-image" onerror="this.src='/uploads/placeholder.jpg'">
                            <div class="product-info">
                                <div class="product-price">S/. ${parseFloat(product.price || 0).toFixed(2)}</div>
                                <div class="product-meta">
                                    ${product.category ? `üìÇ ${product.category}` : 'üìÇ Sin categor√≠a'}
                                    ${product.discount ? ` ‚Ä¢ üè∑Ô∏è -${product.discount}%` : ''}
                                </div>
                                <div class="product-meta" style="margin-top: 0.3rem;">
                                    ${product.shortDesc || 'Sin descripci√≥n'}
                                </div>
                            </div>
                            <div class="stock-badge ${stockClass}">${stockText}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderCategories() {
            const container = document.getElementById('categoriesList');

            if (allCategories.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--muted);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üè∑Ô∏è</div>
                        <p>No hay categor√≠as que mostrar</p>
                        <p style="font-size: 0.9rem;">¬°Crea tu primera categor√≠a!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = allCategories.map(category => {
                return `
                    <div class="category-item ${editingCategoryId === category.id ? 'editing' : ''}" data-id="${category.id}">
                        <div class="category-info">
                            <div class="category-name">${category.label || category.name}</div>
                            <div class="category-internal">Nombre interno: ${category.name}</div>
                        </div>
                        <div class="product-actions">
                            <button class="btn btn-info" onclick="editCategory(${category.id})" title="Editar">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn btn-danger" onclick="showDeleteCategoryModal(${category.id})" title="Eliminar">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function handleSearch(e) {
            const query = e.target.value.toLowerCase().trim();
            
            if (query === '') {
                renderProducts();
                return;
            }

            const filtered = allProducts.filter(product => 
                product.name.toLowerCase().includes(query) ||
                (product.shortDesc && product.shortDesc.toLowerCase().includes(query)) ||
                (product.category && product.category.toLowerCase().includes(query))
            );

            renderProducts(filtered);
        }

        // ================================
        // FORMULARIO DE PRODUCTOS
        // ================================
        async function handleFormSubmit(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const submitLoader = document.getElementById('submitLoader');

            // UI loading
            submitBtn.disabled = true;
            submitText.style.display = 'none';
            submitLoader.style.display = 'inline-block';

            try {
                const formData = new FormData(e.target);
                const productData = Object.fromEntries(formData.entries());

                // Validaciones
                if (!productData.name.trim()) {
                    throw new Error('El nombre del producto es requerido');
                }
                if (!productData.price || parseFloat(productData.price) <= 0) {
                    throw new Error('El precio debe ser mayor a 0');
                }
                if (!productData.stock || parseInt(productData.stock) < 0) {
                    throw new Error('El stock no puede ser negativo');
                }

                // Agregar im√°genes
                productData.images = uploadedImages;

                // Convertir tipos de datos
                productData.price = parseFloat(productData.price);
                productData.stock = parseInt(productData.stock);
                productData.discount = parseInt(productData.discount) || 0;

                console.log('üíæ Guardando producto:', productData);

                const success = await saveProduct(productData);

                if (success) {
                    // Si estamos editando, salir del modo edici√≥n
                    if (editingProductId) {
                        cancelEdit();
                    }
                }

            } catch (error) {
                showAlert('Error: ' + error.message, 'danger');
            } finally {
                // Restaurar UI
                submitBtn.disabled = false;
                submitText.style.display = 'inline';
                submitLoader.style.display = 'none';
            }
        }

        function resetForm() {
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            uploadedImages = [];
        }

        function editProduct(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            console.log('‚úèÔ∏è Editando producto:', product);

            editingProductId = productId;

            // Actualizar UI
            document.getElementById('formTitle').innerHTML = '‚úèÔ∏è Editar Producto';
            document.getElementById('cancelEdit').style.display = 'inline-flex';
            document.getElementById('submitText').textContent = 'üíæ Actualizar Producto';

            // Llenar formulario
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name || '';
            document.getElementById('productPrice').value = product.price || '';
            document.getElementById('productStock').value = product.stock || '';
            document.getElementById('productCategory').value = product.category || '';
            document.getElementById('productDiscount').value = product.discount || '';
            document.getElementById('productDescription').value = product.shortDesc || '';

            // Cargar im√°genes existentes
            const images = product.images ? (typeof product.images === 'string' ? JSON.parse(product.images) : product.images) : [];
            uploadedImages = [...images];
            
            document.getElementById('imagePreview').innerHTML = '';
            images.forEach(imageUrl => {
                addImagePreview(imageUrl, 'Imagen existente', false);
            });

            // Scroll al formulario y resaltar producto
            document.querySelector('.left-panel').scrollIntoView({ behavior: 'smooth' });
            renderProducts(); // Re-renderizar para mostrar estado editing
        }

        function cancelEdit() {
            editingProductId = null;

            // Restaurar UI
            document.getElementById('formTitle').innerHTML = '‚ûï Crear Producto';
            document.getElementById('cancelEdit').style.display = 'none';
            document.getElementById('submitText').textContent = 'üíæ Guardar Producto';

            resetForm();
            renderProducts(); // Re-renderizar para quitar estado editing
        }

        // ================================
        // FORMULARIO DE CATEGOR√çAS
        // ================================
        async function handleCategoryFormSubmit(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('categorySubmitBtn');
            const submitText = document.getElementById('categorySubmitText');
            const submitLoader = document.getElementById('categorySubmitLoader');

            // UI loading
            submitBtn.disabled = true;
            submitText.style.display = 'none';
            submitLoader.style.display = 'inline-block';

            try {
                const formData = new FormData(e.target);
                const categoryData = Object.fromEntries(formData.entries());

                // Validaciones
                if (!categoryData.name.trim()) {
                    throw new Error('El nombre interno de la categor√≠a es requerido');
                }
                if (!categoryData.label.trim()) {
                    throw new Error('El nombre visible de la categor√≠a es requerido');
                }

                console.log('üíæ Guardando categor√≠a:', categoryData);

                const success = await saveCategory(categoryData);

                if (success) {
                    // Si estamos editando, salir del modo edici√≥n
                    if (editingCategoryId) {
                        cancelCategoryEdit();
                    }
                }

            } catch (error) {
                showAlert('Error: ' + error.message, 'danger');
            } finally {
                // Restaurar UI
                submitBtn.disabled = false;
                submitText.style.display = 'inline';
                submitLoader.style.display = 'none';
            }
        }

        function resetCategoryForm() {
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryId').value = '';
        }

        function editCategory(categoryId) {
            const category = allCategories.find(c => c.id === categoryId);
            if (!category) return;

            console.log('‚úèÔ∏è Editando categor√≠a:', category);

            editingCategoryId = categoryId;

            // Actualizar UI
            document.getElementById('categoryFormTitle').innerHTML = '‚úèÔ∏è Editar Categor√≠a';
            document.getElementById('cancelCategoryEdit').style.display = 'inline-flex';
            document.getElementById('categorySubmitText').textContent = 'üíæ Actualizar Categor√≠a';

            // Llenar formulario
            document.getElementById('categoryId').value = category.id;
            document.getElementById('categoryName').value = category.name || '';
            document.getElementById('categoryLabel').value = category.label || '';

            // Re-renderizar para mostrar estado editing
            renderCategories();
        }

        function cancelCategoryEdit() {
            editingCategoryId = null;

            // Restaurar UI
            document.getElementById('categoryFormTitle').innerHTML = '‚ûï Crear Categor√≠a';
            document.getElementById('cancelCategoryEdit').style.display = 'none';
            document.getElementById('categorySubmitText').textContent = 'üíæ Guardar Categor√≠a';

            resetCategoryForm();
            renderCategories(); // Re-renderizar para quitar estado editing
        }

        // ================================
        // MODAL DE ELIMINACI√ìN DE PRODUCTOS
        // ================================
        function showDeleteModal(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            productToDelete = product;

            const modal = document.getElementById('deleteModal');
            const info = document.getElementById('deleteProductInfo');

            const images = product.images ? (typeof product.images === 'string' ? JSON.parse(product.images) : product.images) : [];
            const mainImage = images.length > 0 ? images[0] : '/uploads/placeholder.jpg';

            info.innerHTML = `
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <img src="${mainImage}" alt="${product.name}" style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover;" onerror="this.src='/uploads/placeholder.jpg'">
                    <div>
                        <div style="font-weight: bold; margin-bottom: 0.5rem;">${product.name}</div>
                        <div style="color: var(--muted); font-size: 0.9rem;">
                            S/. ${parseFloat(product.price || 0).toFixed(2)} ‚Ä¢ Stock: ${product.stock || 0}
                        </div>
                    </div>
                </div>
            `;

            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            document.body.style.overflow = '';
            productToDelete = null;
        }

        async function confirmDelete() {
            if (!productToDelete) return;

            const success = await deleteProduct(productToDelete.id);
            if (success) {
                closeDeleteModal();
                
                // Si estamos editando este producto, cancelar edici√≥n
                if (editingProductId === productToDelete.id) {
                    cancelEdit();
                }
            }
        }

        // ================================
        // MODAL DE ELIMINACI√ìN DE CATEGOR√çAS
        // ================================
        function showDeleteCategoryModal(categoryId) {
            const category = allCategories.find(c => c.id === categoryId);
            if (!category) return;

            categoryToDelete = category;

            const modal = document.getElementById('deleteCategoryModal');
            const info = document.getElementById('deleteCategoryInfo');

            info.innerHTML = `
                <div>
                    <div style="font-weight: bold; margin-bottom: 0.5rem;">${category.label || category.name}</div>
                    <div style="color: var(--muted); font-size: 0.9rem;">
                        Nombre interno: ${category.name}
                    </div>
                </div>
            `;

            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeDeleteCategoryModal() {
            document.getElementById('deleteCategoryModal').classList.remove('show');
            document.body.style.overflow = '';
            categoryToDelete = null;
        }

        async function confirmDeleteCategory() {
            if (!categoryToDelete) return;

            const success = await deleteCategory(categoryToDelete.id);
            if (success) {
                closeDeleteCategoryModal();
                
                // Si estamos editando esta categor√≠a, cancelar edici√≥n
                if (editingCategoryId === categoryToDelete.id) {
                    cancelCategoryEdit();
                }
            }
        }

        // ================================
        // ALERTAS
        // ================================
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alerts-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: inherit; cursor: pointer; font-size: 1.2rem;">√ó</button>
                </div>
            `;

            container.appendChild(alert);

            // Auto-remove despu√©s de 5 segundos
            setTimeout(() => {
                if (alert.parentElement) {
                    alert.remove();
                }
            }, 5000);

            console.log(`üì¢ ${type.toUpperCase()}: ${message}`);
        }

        // ================================
        // UTILIDADES
        // ================================
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-PE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatPrice(price) {
            return `S/. ${parseFloat(price || 0).toFixed(2)}`;
        }

        // ================================
        // ATAJOS DE TECLADO
        // ================================
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + S para guardar
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab) {
                    if (activeTab.id === 'products-tab') {
                        const form = document.getElementById('productForm');
                        if (form) {
                            form.dispatchEvent(new Event('submit', { bubbles: true }));
                        }
                    } else if (activeTab.id === 'categories-tab') {
                        const form = document.getElementById('categoryForm');
                        if (form) {
                            form.dispatchEvent(new Event('submit', { bubbles: true }));
                        }
                    }
                }
            }
            
            // Ctrl/Cmd + N para nuevo elemento
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab) {
                    if (activeTab.id === 'products-tab' && editingProductId) {
                        cancelEdit();
                    } else if (activeTab.id === 'categories-tab' && editingCategoryId) {
                        cancelCategoryEdit();
                    }
                }
            }
        });

        // ================================
        // FUNCIONES ADICIONALES
        // ================================
        function exportProducts() {
            try {
                const dataStr = JSON.stringify(allProducts, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `productos_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showAlert('‚úÖ Productos exportados correctamente', 'success');
            } catch (error) {
                showAlert('Error al exportar productos: ' + error.message, 'danger');
            }
        }

        function exportCategories() {
            try {
                const dataStr = JSON.stringify(allCategories, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `categorias_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showAlert('‚úÖ Categor√≠as exportadas correctamente', 'success');
            } catch (error) {
                showAlert('Error al exportar categor√≠as: ' + error.message, 'danger');
            }
        }

        // ================================
        // CONSOLA DE DEBUG
        // ================================
        console.log('üí° Funciones disponibles en la consola:');
        console.log('‚Ä¢ exportProducts() - Exportar todos los productos');
        console.log('‚Ä¢ exportCategories() - Exportar todas las categor√≠as');
        console.log('‚Ä¢ loadData() - Recargar datos del servidor');
        console.log('‚Ä¢ showAlert(message, type) - Mostrar alerta personalizada');
        console.log('‚Ä¢ resetForm() - Limpiar formulario de productos');
        console.log('‚Ä¢ resetCategoryForm() - Limpiar formulario de categor√≠as');
        console.log('‚Ä¢ switchTab(tabName, button) - Cambiar pesta√±a');

        // Exponer funciones globalmente para debug
        window.adminFunctions = {
            exportProducts,
            exportCategories,
            loadData,
            showAlert,
            resetForm,
            resetCategoryForm,
            editProduct,
            editCategory,
            deleteProduct,
            deleteCategory,
            switchTab
        };

        // ================================
        // VALIDACIONES ADICIONALES
        // ================================
        
        // Validar nombre interno de categor√≠a (sin espacios, solo letras y guiones)
        document.getElementById('categoryName').addEventListener('input', function(e) {
            let value = e.target.value;
            // Convertir a lowercase y reemplazar espacios por guiones
            value = value.toLowerCase().replace(/[^a-z0-9-_]/g, '');
            e.target.value = value;
        });

        // Auto-generar nombre interno desde nombre visible
        document.getElementById('categoryLabel').addEventListener('input', function(e) {
            const nameField = document.getElementById('categoryName');
            if (!nameField.value || !editingCategoryId) { // Solo auto-generar si est√° vac√≠o o es nuevo
                const value = e.target.value.toLowerCase()
                    .replace(/[√°√†√§√¢]/g, 'a')
                    .replace(/[√©√®√´√™]/g, 'e')
                    .replace(/[√≠√¨√Ø√Æ]/g, 'i')
                    .replace(/[√≥√≤√∂√¥]/g, 'o')
                    .replace(/[√∫√π√º√ª]/g, 'u')
                    .replace(/[√±]/g, 'n')
                    .replace(/[^a-z0-9]/g, '-')
                    .replace(/-+/g, '-')
                    .replace(/^-|-$/g, '');
                nameField.value = value;
            }
        });

        // ================================
        // MEJORAS UX
        // ================================
        
        // Tooltip para botones
        document.addEventListener('mouseover', function(e) {
            if (e.target.classList.contains('btn') && e.target.title) {
                // Crear tooltip personalizado si es necesario
            }
        });

        // Confirmaci√≥n antes de salir si hay cambios sin guardar
        let formHasChanges = false;
        let categoryFormHasChanges = false;

        document.getElementById('productForm').addEventListener('input', () => {
            formHasChanges = true;
        });

        document.getElementById('categoryForm').addEventListener('input', () => {
            categoryFormHasChanges = true;
        });

        document.getElementById('productForm').addEventListener('submit', () => {
            formHasChanges = false;
        });

        document.getElementById('categoryForm').addEventListener('submit', () => {
            categoryFormHasChanges = false;
        });

        window.addEventListener('beforeunload', function(e) {
            if (formHasChanges || categoryFormHasChanges) {
                e.preventDefault();
                e.returnValue = '¬øEst√°s seguro de que quieres salir? Hay cambios sin guardar.';
                return e.returnValue;
            }
        });

        // ================================
        // AUTO-SAVE (OPCIONAL)
        // ================================
        
        // Guardar borradores cada 30 segundos
        setInterval(() => {
            if (formHasChanges && !editingProductId) {
                const formData = new FormData(document.getElementById('productForm'));
                const draft = Object.fromEntries(formData.entries());
                try {
                    localStorage.setItem('productDraft', JSON.stringify(draft));
                    console.log('üíæ Borrador de producto guardado autom√°ticamente');
                } catch (error) {
                    console.warn('‚ùå No se pudo guardar el borrador:', error);
                }
            }
            
            if (categoryFormHasChanges && !editingCategoryId) {
                const formData = new FormData(document.getElementById('categoryForm'));
                const draft = Object.fromEntries(formData.entries());
                try {
                    localStorage.setItem('categoryDraft', JSON.stringify(draft));
                    console.log('üíæ Borrador de categor√≠a guardado autom√°ticamente');
                } catch (error) {
                    console.warn('‚ùå No se pudo guardar el borrador:', error);
                }
            }
        }, 30000);

        // Cargar borradores al iniciar
        function loadDrafts() {
            try {
                const productDraft = localStorage.getItem('productDraft');
                const categoryDraft = localStorage.getItem('categoryDraft');
                
                if (productDraft && !editingProductId) {
                    const draft = JSON.parse(productDraft);
                    if (draft.name || draft.price) {
                        const shouldLoad = confirm('Se encontr√≥ un borrador de producto sin guardar. ¬øQuieres cargarlo?');
                        if (shouldLoad) {
                            Object.keys(draft).forEach(key => {
                                const field = document.getElementById('product' + key.charAt(0).toUpperCase() + key.slice(1));
                                if (field && draft[key]) {
                                    field.value = draft[key];
                                }
                            });
                            formHasChanges = true;
                        }
                        localStorage.removeItem('productDraft');
                    }
                }
                
                if (categoryDraft && !editingCategoryId) {
                    const draft = JSON.parse(categoryDraft);
                    if (draft.name || draft.label) {
                        const shouldLoad = confirm('Se encontr√≥ un borrador de categor√≠a sin guardar. ¬øQuieres cargarlo?');
                        if (shouldLoad) {
                            Object.keys(draft).forEach(key => {
                                const field = document.getElementById('category' + key.charAt(0).toUpperCase() + key.slice(1));
                                if (field && draft[key]) {
                                    field.value = draft[key];
                                }
                            });
                            categoryFormHasChanges = true;
                        }
                        localStorage.removeItem('categoryDraft');
                    }
                }
            } catch (error) {
                console.warn('‚ùå Error cargando borradores:', error);
            }
        }

        // Cargar borradores despu√©s de un peque√±o delay
        setTimeout(loadDrafts, 1000);

        // ================================
        // NOTIFICACIONES DE ESTADO
        // ================================
        
        // Mostrar estado de conexi√≥n
        function updateConnectionStatus() {
            const isOnline = navigator.onLine;
            if (!isOnline) {
                showAlert('‚ö†Ô∏è Sin conexi√≥n a internet. Los cambios se guardar√°n cuando se restablezca la conexi√≥n.', 'warning');
            }
        }

        window.addEventListener('online', () => {
            showAlert('‚úÖ Conexi√≥n restablecida', 'success');
        });

        window.addEventListener('offline', updateConnectionStatus);

        // ================================
        // ESTAD√çSTICAS EN TIEMPO REAL
        // ================================
        
        // Actualizar estad√≠sticas cada vez que cambian los datos
        function updateStatsRealTime() {
            updateStats();
            
            // Agregar animaci√≥n a los n√∫meros que cambian
            document.querySelectorAll('.stat-number').forEach(stat => {
                stat.style.transform = 'scale(1.1)';
                stat.style.color = 'var(--accent)';
                setTimeout(() => {
                    stat.style.transform = 'scale(1)';
                }, 200);
            });
        }

        // Observar cambios en los arrays de datos
        let originalPush = Array.prototype.push;
        Array.prototype.push = function(...args) {
            const result = originalPush.apply(this, args);
            if (this === allProducts || this === allCategories) {
                setTimeout(updateStatsRealTime, 100);
            }
            return result;
        };

        console.log('üéâ Panel de administraci√≥n cargado completamente');
        console.log('üìä Estad√≠sticas:', {
            productos: allProducts.length,
            categor√≠as: allCategories.length,
            stockTotal: allProducts.reduce((sum, p) => sum + (p.stock || 0), 0)
        });
    </script>
</body>
</html>