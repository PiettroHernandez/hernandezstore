<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Hernandezstore - Panel de Administraci√≥n</title>
<style>
body { font-family: Arial, sans-serif; background: #121212; color: white; margin: 0; }
header { background: #1e1e1e; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
header h1 { margin: 0; font-size: 1.2rem; }
header button { background: #ff4b4b; border: none; padding: 0.5rem 1rem; color: white; cursor: pointer; border-radius: 4px; }
header button:hover { background: #cc0000; }
.container { max-width: 900px; margin: auto; padding: 1rem; }
input, select, textarea { width: 100%; padding: 0.5rem; margin: 0.25rem 0; background: #1e1e1e; border: none; color: white; border-radius: 4px; box-sizing: border-box; }
button { padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; margin: 0.25rem; }
.add-btn { background: #6200ee; color: white; }
.save-btn { background: #4CAF50; color: white; }
.cancel-btn { background: #777; color: white; }
.edit-btn { background: orange; color: black; }
.delete-btn { background: red; color: white; }
.product { background: #1e1e1e; padding: 0.5rem; margin: 0.5rem 0; display: flex; justify-content: space-between; align-items: center; border-radius: 6px; }
.product img { max-height: 40px; margin-right: 10px; border-radius: 4px; }
.img-preview { max-height: 120px; margin-top: 10px; display: block; border-radius: 8px; border: 2px solid #333; }

/* Estilos para imagen de fallback */
.no-image-placeholder {
    width: 40px;
    height: 40px;
    background: #333;
    border-radius: 4px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-right: 10px;
    color: #666;
    font-size: 12px;
    text-align: center;
}

/* Zona de arrastrar y soltar */
.image-upload-area {
    border: 2px dashed #555;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    margin: 1rem 0;
    background: #1a1a1a;
    transition: all 0.3s ease;
    cursor: pointer;
}

.image-upload-area.drag-over {
    border-color: #6200ee;
    background: #2a1a4a;
}

.image-upload-area:hover {
    border-color: #777;
    background: #252525;
}

.upload-icon {
    font-size: 3rem;
    color: #555;
    margin-bottom: 1rem;
}

.upload-text {
    color: #aaa;
    font-size: 1rem;
    margin-bottom: 0.5rem;
}

.upload-subtext {
    color: #777;
    font-size: 0.9rem;
}

.image-options {
    display: flex;
    gap: 1rem;
    margin: 1rem 0;
    align-items: center;
}

.image-options label {
    color: #ccc;
    font-weight: bold;
}

.url-input {
    flex: 1;
}

.add-url-btn {
    background: #6200ee;
    color: white;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    white-space: nowrap;
}

.add-url-btn:hover {
    background: #5000cc;
}

.image-preview-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.image-item {
    position: relative;
    display: inline-block;
}

.image-item img {
    max-height: 80px;
    max-width: 80px;
    object-fit: cover;
    border-radius: 6px;
    border: 2px solid #333;
}

.remove-image {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff4444;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.remove-image:hover {
    background: #cc0000;
}

.hidden-file-input {
    display: none;
}

/* Responsive */
@media (max-width: 600px) {
    .image-options {
        flex-direction: column;
        align-items: stretch;
    }
    
    .add-url-btn {
        margin-top: 0.5rem;
    }
}

/* Estilos para importador CSV */
.csv-import-section {
    background: #1a1a1a;
    border-radius: 8px;
    padding: 1.5rem;
    margin: 1rem 0;
    border: 1px solid #333;
}

.csv-import-section h3 {
    margin-top: 0;
    color: #fff;
    font-size: 1.1rem;
}

.csv-upload-area {
    border: 2px dashed #555;
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
    margin: 1rem 0;
    background: #252525;
    transition: all 0.3s ease;
    cursor: pointer;
}

.csv-upload-area.drag-over {
    border-color: #4CAF50;
    background: #1a3a1a;
}

.csv-upload-area:hover {
    border-color: #777;
    background: #2a2a2a;
}

.csv-options {
    display: flex;
    gap: 0.5rem;
    margin: 1rem 0;
    flex-wrap: wrap;
}

.template-btn {
    background: #2196F3;
    color: white;
}

.template-btn:hover {
    background: #1976D2;
}

.import-btn {
    background: #4CAF50;
    color: white;
}

.import-btn:hover {
    background: #45a049;
}

.csv-preview {
    background: #2a2a2a;
    border-radius: 6px;
    padding: 1rem;
    margin: 1rem 0;
}

.csv-preview h4 {
    margin: 0 0 1rem 0;
    color: #fff;
}

.csv-table-container {
    overflow-x: auto;
    margin: 1rem 0;
}

.csv-table-container table {
    width: 100%;
    border-collapse: collapse;
    background: #1e1e1e;
    border-radius: 4px;
    overflow: hidden;
}

.csv-table-container th,
.csv-table-container td {
    padding: 0.5rem;
    text-align: left;
    border-bottom: 1px solid #444;
    color: white;
    font-size: 0.9rem;
}

.csv-table-container th {
    background: #333;
    font-weight: bold;
}

.csv-table-container tr:hover {
    background: #333;
}

#csvStats {
    color: #aaa;
    font-size: 0.9rem;
    margin: 0.5rem 0;
}

/* Mensaje de error de imagen */
.image-error {
    color: #ff6b6b;
    font-size: 0.8rem;
    margin-top: 0.25rem;
}
</style>
</head>
<body>
<header>
  <h1>Panel de Administraci√≥n</h1>
  <button onclick="logout()">Cerrar sesi√≥n</button>
</header>
<div class="container">
  <h2>Lista de Productos</h2>
  
  <!-- Secci√≥n de importaci√≥n CSV -->
  <div class="csv-import-section">
    <h3>Importar Productos desde CSV</h3>
    <div class="csv-upload-area" id="csvUploadArea">
      <div class="upload-icon">üìä</div>
      <div class="upload-text">Arrastra un archivo CSV aqu√≠ o haz clic para seleccionar</div>
      <div class="upload-subtext">Formato: nombre,descripcion,precio,stock,categoria,descuento,imagen_url</div>
    </div>
    <input type="file" id="csvFile" class="hidden-file-input" accept=".csv,.txt" />
    
    <div class="csv-options">
      <button id="downloadTemplate" class="template-btn">üì• Descargar Plantilla CSV</button>
      <button id="importCsv" class="import-btn" style="display:none;">üì§ Importar Productos</button>
      <button id="cancelImport" class="cancel-btn" style="display:none;">‚ùå Cancelar</button>
    </div>
    
    <div id="csvPreview" class="csv-preview" style="display:none;">
      <h4>Vista previa (primeras 5 filas):</h4>
      <div class="csv-table-container">
        <table id="csvPreviewTable"></table>
      </div>
      <p id="csvStats"></p>
    </div>
  </div>
  
  <div id="list"></div>
  <h3 id="form-title">Agregar producto</h3>
  <input id="name" placeholder="Nombre del producto">
  <textarea id="shortDesc" placeholder="Descripci√≥n corta"></textarea>
  <input id="price" placeholder="Precio" type="number" step="0.01">
  <input id="stock" placeholder="Cantidad en stock" type="number" min="0" step="1">
  <select id="category"></select>
  <input id="newCategory" placeholder="Nueva categor√≠a (opcional)">
  <input id="discount" placeholder="Descuento (%)" type="number" min="0" max="100">
  
  <!-- Nueva √°rea de carga de im√°genes -->
  <div class="image-upload-area" id="uploadArea">
    <div class="upload-icon">üñºÔ∏è</div>
    <div class="upload-text">Arrastra y suelta im√°genes aqu√≠</div>
    <div class="upload-subtext">o haz clic para seleccionar archivos</div>
  </div>
  
  <input type="file" id="image" class="hidden-file-input" multiple accept="image/*">
  
  <div class="image-options">
    <label>O pega una URL:</label>
    <input type="url" id="imageUrl" class="url-input" placeholder="https://ejemplo.com/imagen.jpg">
    <button type="button" class="add-url-btn" id="addUrlBtn">Agregar URL</button>
  </div>
  
  <div id="imagePreviewContainer" class="image-preview-container"></div>
  
  <button id="actionBtn" class="add-btn">Agregar</button>
  <button id="cancelBtn" class="cancel-btn" style="display:none;">Cancelar</button>
</div>

<script>
function logout(){
  fetch('/logout', { method: 'POST' }).then(() => window.location.href = '/login.html');
}

let products = [];
let categories = [];
let editId = null;
let currentImages = []; // Array para m√∫ltiples im√°genes
let csvData = []; // Datos del CSV cargado

// Configurar drag & drop para im√°genes
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('image');
const imageUrl = document.getElementById('imageUrl');
const addUrlBtn = document.getElementById('addUrlBtn');
const previewContainer = document.getElementById('imagePreviewContainer');

// Configurar importador CSV
const csvUploadArea = document.getElementById('csvUploadArea');
const csvFileInput = document.getElementById('csvFile');
const downloadTemplate = document.getElementById('downloadTemplate');
const importCsv = document.getElementById('importCsv');
const cancelImport = document.getElementById('cancelImport');
const csvPreview = document.getElementById('csvPreview');

// Eventos de drag & drop para im√°genes
uploadArea.addEventListener('click', () => fileInput.click());
uploadArea.addEventListener('dragover', handleDragOver);
uploadArea.addEventListener('dragleave', handleDragLeave);
uploadArea.addEventListener('drop', handleDrop);
fileInput.addEventListener('change', handleFileSelect);
addUrlBtn.addEventListener('click', addImageUrl);

// Eventos para importador CSV
csvUploadArea.addEventListener('click', () => csvFileInput.click());
csvUploadArea.addEventListener('dragover', handleCsvDragOver);
csvUploadArea.addEventListener('dragleave', handleCsvDragLeave);
csvUploadArea.addEventListener('drop', handleCsvDrop);
csvFileInput.addEventListener('change', handleCsvFileSelect);
downloadTemplate.addEventListener('click', downloadCsvTemplate);
importCsv.addEventListener('click', importCsvData);
cancelImport.addEventListener('click', cancelCsvImport);

// Funci√≥n para crear imagen de fallback
function createFallbackImage() {
    const div = document.createElement('div');
    div.className = 'no-image-placeholder';
    div.textContent = 'Sin imagen';
    return div;
}

// Funci√≥n mejorada para manejar errores de imagen
function handleImageError(img, fallbackUrl = null) {
    // Evitar loops infinitos
    if (img.dataset.fallbackAttempted) {
        const placeholder = createFallbackImage();
        img.parentNode.replaceChild(placeholder, img);
        return;
    }

    // Marcar que ya intentamos el fallback
    img.dataset.fallbackAttempted = 'true';
    
    // Usar el fallback proporcionado o el por defecto
    const defaultFallback = 'data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2240%22%20height%3D%2240%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22%23333%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20dominant-baseline%3D%22central%22%20text-anchor%3D%22middle%22%20font-size%3D%228%22%20fill%3D%22%23666%22%3ESin%3C%2Ftext%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2265%25%22%20dominant-baseline%3D%22central%22%20text-anchor%3D%22middle%22%20font-size%3D%228%22%20fill%3D%22%23666%22%3EImagen%3C%2Ftext%3E%3C%2Fsvg%3E';
    
    img.src = fallbackUrl || defaultFallback;
}

function handleDragOver(e) {
    e.preventDefault();
    uploadArea.classList.add('drag-over');
}

function handleDragLeave(e) {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
}

function handleDrop(e) {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
    const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
    processFiles(files);
}

function handleFileSelect(e) {
    const files = Array.from(e.target.files);
    processFiles(files);
}

function processFiles(files) {
    files.forEach(file => {
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                addImageToPreview(e.target.result, 'file', file);
            };
            reader.readAsDataURL(file);
        }
    });
}

function addImageUrl() {
    const url = imageUrl.value.trim();
    if (url && isValidImageUrl(url)) {
        addImageToPreview(url, 'url');
        imageUrl.value = '';
    } else {
        alert('Por favor, ingresa una URL v√°lida de imagen');
    }
}

function isValidImageUrl(url) {
    try {
        new URL(url);
        return /\.(jpg|jpeg|png|gif|webp|svg)(\?|$)/i.test(url) || 
               url.includes('unsplash') || 
               url.includes('imgur') ||
               url.includes('picsum') ||
               url.includes('cloudinary') ||
               url.startsWith('data:image/') ||
               url.startsWith('/') || // URLs relativas
               url.startsWith('./'); // URLs relativas
    } catch {
        return false;
    }
}

function addImageToPreview(src, type, file = null) {
    const imageData = {
        src: src,
        type: type,
        file: file,
        id: Date.now() + Math.random()
    };
    
    currentImages.push(imageData);
    renderImagePreviews();
}

function removeImage(imageId) {
    currentImages = currentImages.filter(img => img.id !== imageId);
    renderImagePreviews();
}

function renderImagePreviews() {
    previewContainer.innerHTML = '';
    currentImages.forEach(imageData => {
        const imageItem = document.createElement('div');
        imageItem.className = 'image-item';
        
        const img = document.createElement('img');
        img.src = imageData.src;
        img.alt = 'Preview';
        img.style.maxHeight = '80px';
        img.style.maxWidth = '80px';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '6px';
        img.style.border = '2px solid #333';
        img.onerror = function() { handleImageError(this); };
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-image';
        removeBtn.innerHTML = '&times;';
        removeBtn.onclick = () => removeImage(imageData.id);
        
        imageItem.appendChild(img);
        imageItem.appendChild(removeBtn);
        previewContainer.appendChild(imageItem);
    });
}

async function loadFromServer(){
  try {
    const res = await fetch('/api/data');
    const data = await res.json();
    products = data.products || [];
    categories = data.categories?.map(c => c.name) || [];
    
    // LIMPIAR URLs PROBLEM√ÅTICAS DE PRODUCTOS EXISTENTES
    let needsUpdate = false;
    products = products.map(product => {
      if (product.images && product.images.length > 0) {
        const cleanImages = product.images.filter(img => 
          !img.includes('via.placeholder.com') && 
          !img.includes('placeholder.com') &&
          img.trim() !== ''
        );
        
        if (cleanImages.length !== product.images.length) {
          product.images = cleanImages;
          needsUpdate = true;
        }
      }
      return product;
    });
    
    // Si encontramos URLs problem√°ticas, guardar la versi√≥n limpia
    if (needsUpdate) {
      console.log('Limpiando URLs problem√°ticas de productos existentes...');
      await saveToServer();
    }
    
    render();
    fillCategories();
  } catch (error) {
    console.error('Error cargando datos:', error);
    alert('Error al cargar los datos del servidor');
  }
}

function fillCategories(){
  const sel = document.getElementById('category');
  sel.innerHTML = '<option value="">Seleccionar categor√≠a</option>';
  categories.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    sel.appendChild(opt);
  });
}

function render(){
  const list = document.getElementById('list');
  list.innerHTML = '';
  
  // Imagen por defecto que siempre funciona
  const defaultImage = 'data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2240%22%20height%3D%2240%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22%23333%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20dominant-baseline%3D%22central%22%20text-anchor%3D%22middle%22%20font-size%3D%228%22%20fill%3D%22%23666%22%3ESin%3C%2Ftext%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2265%25%22%20dominant-baseline%3D%22central%22%20text-anchor%3D%22middle%22%20font-size%3D%228%22%20fill%3D%22%23666%22%3EImagen%3C%2Ftext%3E%3C%2Fsvg%3E';
  
  products.forEach((p,i) => {
    let imgSrc = defaultImage;
    
    // Solo usar imagen del producto si existe y es v√°lida
    if (p.images && p.images.length > 0) {
      const validImage = p.images.find(img => 
        img && 
        img.trim() !== '' && 
        !img.includes('via.placeholder.com') && 
        !img.includes('placeholder.com')
      );
      
      if (validImage) {
        imgSrc = validImage;
      }
    }
    
    const discountTxt = p.discount ? ` (${p.discount}% desc.)` : '';
    const stockTxt = p.stock !== undefined ? ` - Stock: ${p.stock}` : '';
    
    const productDiv = document.createElement('div');
    productDiv.className = 'product';
    
    // Crear elementos por separado para mejor control
    const span = document.createElement('span');
    const img = document.createElement('img');
    img.src = imgSrc;
    img.alt = p.name || 'Producto';
    img.style.maxHeight = '40px';
    img.style.marginRight = '10px';
    img.style.borderRadius = '4px';
    img.onerror = function() { 
      if (this.src !== defaultImage) {
        this.src = defaultImage;
      }
    };
    
    const text = document.createTextNode(`${p.name} - S/.${p.price}${discountTxt}${stockTxt}`);
    span.appendChild(img);
    span.appendChild(text);
    
    const buttonDiv = document.createElement('div');
    const editBtn = document.createElement('button');
    editBtn.className = 'edit-btn';
    editBtn.textContent = 'Editar';
    editBtn.onclick = () => edit(i);
    
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete-btn';
    deleteBtn.textContent = 'Eliminar';
    deleteBtn.onclick = () => del(i);
    
    buttonDiv.appendChild(editBtn);
    buttonDiv.appendChild(deleteBtn);
    
    productDiv.appendChild(span);
    productDiv.appendChild(buttonDiv);
    list.appendChild(productDiv);
  });
}

function del(i){
  if (confirm('¬øEst√°s seguro de que quieres eliminar este producto?')) {
    products.splice(i,1);
    saveToServer();
    render();
  }
}

function edit(i){
  const p = products[i];
  editId = p.id;
  document.getElementById('name').value = p.name;
  document.getElementById('shortDesc').value = p.shortDesc || '';
  document.getElementById('price').value = p.price;
  document.getElementById('stock').value = p.stock !== undefined ? p.stock : 0;
  document.getElementById('category').value = p.category || '';
  document.getElementById('discount').value = p.discount || '';
  
  // Cargar im√°genes existentes
  currentImages = [];
  if (p.images && p.images.length) {
    p.images.forEach(imgUrl => {
      addImageToPreview(imgUrl, 'url');
    });
  }
  
  document.getElementById('form-title').textContent = 'Editar producto';
  document.getElementById('actionBtn').textContent = 'Guardar cambios';
  document.getElementById('actionBtn').className = 'save-btn';
  document.getElementById('cancelBtn').style.display = 'inline-block';
}

document.getElementById('cancelBtn').onclick = () => resetForm();

function resetForm(){
  editId = null;
  currentImages = [];
  document.getElementById('name').value = '';
  document.getElementById('shortDesc').value = '';
  document.getElementById('price').value = '';
  document.getElementById('stock').value = '';
  document.getElementById('newCategory').value = '';
  document.getElementById('discount').value = '';
  document.getElementById('image').value = '';
  document.getElementById('imageUrl').value = '';
  renderImagePreviews();
  document.getElementById('form-title').textContent = 'Agregar producto';
  document.getElementById('actionBtn').textContent = 'Agregar';
  document.getElementById('actionBtn').className = 'add-btn';
  document.getElementById('cancelBtn').style.display = 'none';
}

document.getElementById('actionBtn').onclick = async () => {
  const name = document.getElementById('name').value.trim();
  const shortDesc = document.getElementById('shortDesc').value.trim();
  const price = parseFloat(document.getElementById('price').value);
  const stock = parseInt(document.getElementById('stock').value) || 0;
  let category = document.getElementById('category').value;
  const newCategory = document.getElementById('newCategory').value.trim();
  
  if(newCategory){
    if (!categories.includes(newCategory)) {
      categories.push(newCategory);
      category = newCategory;
      fillCategories();
    }
  }
  
  const discount = parseInt(document.getElementById('discount').value) || null;

  if(!name || isNaN(price)) {
    alert('Por favor, completa el nombre y precio del producto');
    return;
  }

  if (price <= 0) {
    alert('El precio debe ser mayor a 0');
    return;
  }

  // Procesar im√°genes
  let finalImages = [];
  
  try {
    document.getElementById('actionBtn').textContent = 'Procesando...';
    document.getElementById('actionBtn').disabled = true;
    
    for (const imageData of currentImages) {
      if (imageData.type === 'file' && imageData.file) {
        // Subir archivo
        const formData = new FormData();
        formData.append('images', imageData.file);
        try {
          const uploadRes = await fetch('/api/upload', { method: 'POST', body: formData });
          const uploadData = await uploadRes.json();
          if (uploadData.urls && uploadData.urls[0]) {
            finalImages.push(uploadData.urls[0]);
          }
        } catch (uploadError) {
          console.warn('Error subiendo imagen:', uploadError);
          // Si falla la subida, usar la URL de datos
          finalImages.push(imageData.src);
        }
      } else if (imageData.type === 'url') {
        // Usar URL directamente
        finalImages.push(imageData.src);
      }
    }

    const productData = {
      id: editId || Date.now(),
      name,
      shortDesc,
      price,
      stock,
      category,
      discount,
      images: finalImages
    };

    if(editId){
      // Actualizar producto existente
      try {
        await fetch(`/api/products/${editId}`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(productData)
        });
      } catch (error) {
        console.warn('Error en API, actualizando localmente:', error);
      }
      
      const idx = products.findIndex(p => p.id === editId);
      if (idx !== -1) {
        products[idx] = productData;
      }
    } else {
      // Agregar nuevo producto
      products.push(productData);
    }

    await saveToServer();
    render();
    resetForm();
    alert(editId ? 'Producto actualizado correctamente' : 'Producto agregado correctamente');
    
  } catch (error) {
    console.error('Error procesando producto:', error);
    alert('Error al procesar el producto. Int√©ntalo de nuevo.');
  } finally {
    document.getElementById('actionBtn').textContent = editId ? 'Guardar cambios' : 'Agregar';
    document.getElementById('actionBtn').disabled = false;
  }
};

async function saveToServer(){
  try {
    const res = await fetch('/api/data');
    let data = await res.json();
    data.products = products;
    data.categories = categories.map((name, i) => ({id: i+1, name, label: name}));
    
    await fetch('/api/saveAll', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });
  } catch (error) {
    console.error('Error guardando en servidor:', error);
    alert('Error al guardar los cambios en el servidor');
  }
}

// Prevenir comportamiento por defecto del navegador para drag & drop
window.addEventListener('dragover', e => e.preventDefault());
window.addEventListener('drop', e => e.preventDefault());

// Cargar datos al iniciar
loadFromServer();

// ===== FUNCIONES PARA IMPORTADOR CSV =====

function handleCsvDragOver(e) {
    e.preventDefault();
    csvUploadArea.classList.add('drag-over');
}

function handleCsvDragLeave(e) {
    e.preventDefault();
    csvUploadArea.classList.remove('drag-over');
}

function handleCsvDrop(e) {
    e.preventDefault();
    csvUploadArea.classList.remove('drag-over');
    const files = Array.from(e.dataTransfer.files).filter(file => 
        file.type === 'text/csv' || file.name.endsWith('.csv') || file.type === 'text/plain'
    );
    if (files.length > 0) {
        processCsvFile(files[0]);
    }
}

function handleCsvFileSelect(e) {
    const file = e.target.files[0];
    if (file) {
        processCsvFile(file);
    }
}

function processCsvFile(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const csvContent = e.target.result;
        parseCsvContent(csvContent);
    };
    reader.readAsText(file, 'UTF-8');
}

function parseCsvContent(csvContent) {
    try {
        // Parsear CSV simple - dividir por l√≠neas y luego por comas
        const lines = csvContent.trim().split('\n');
        if (lines.length < 2) {
            alert('El archivo CSV debe tener al menos una fila de encabezados y una fila de datos');
            return;
        }

        // Detectar el separador (coma o punto y coma)
        const separator = lines[0].includes(';') ? ';' : ',';
        
        // Parsear encabezados
        const headers = lines[0].split(separator).map(h => h.trim().replace(/"/g, ''));
        
        // Parsear datos
        const data = [];
        for (let i = 1; i < lines.length; i++) {
            if (lines[i].trim()) {
                const values = parseCsvLine(lines[i], separator);
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                data.push(row);
            }
        }

        csvData = data;
        showCsvPreview(headers, data);
        
    } catch (error) {
        console.error('Error parsing CSV:', error);
        alert('Error al procesar el archivo CSV. Aseg√∫rate de que est√© en el formato correcto.');
    }
}

function parseCsvLine(line, separator) {
    const values = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === separator && !inQuotes) {
            values.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }
    
    values.push(current.trim());
    return values.map(v => v.replace(/"/g, ''));
}

function showCsvPreview(headers, data) {
    const table = document.getElementById('csvPreviewTable');
    const stats = document.getElementById('csvStats');
    
    // Limpiar tabla
    table.innerHTML = '';
    
    // Crear encabezados
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // Crear filas de datos (m√°ximo 5 para preview)
    const tbody = document.createElement('tbody');
    const previewData = data.slice(0, 5);
    previewData.forEach(row => {
        const tr = document.createElement('tr');
        headers.forEach(header => {
            const td = document.createElement('td');
            td.textContent = row[header] || '';
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    
    // Mostrar estad√≠sticas
    stats.textContent = `Total de productos a importar: ${data.length}`;
    
    // Mostrar preview y botones
    csvPreview.style.display = 'block';
    importCsv.style.display = 'inline-block';
    cancelImport.style.display = 'inline-block';
}

function downloadCsvTemplate() {
    const template = `nombre,descripcion,precio,stock,categoria,descuento,imagen_url
"Producto Ejemplo 1","Descripci√≥n del producto 1",29.99,10,"Electr√≥nicos",15,"data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22200%22%20height%3D%22200%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22%234CAF50%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20dominant-baseline%3D%22central%22%20text-anchor%3D%22middle%22%20font-size%3D%2216%22%20fill%3D%22white%22%3EProducto%201%3C%2Ftext%3E%3C%2Fsvg%3E"
"Producto Ejemplo 2","Descripci√≥n del producto 2",45.50,5,"Ropa",0,"data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22200%22%20height%3D%22200%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22%232196F3%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20dominant-baseline%3D%22central%22%20text-anchor%3D%22middle%22%20font-size%3D%2216%22%20fill%3D%22white%22%3EProducto%202%3C%2Ftext%3E%3C%2Fsvg%3E"
"Producto Ejemplo 3","Descripci√≥n del producto 3",12.99,20,"Hogar",10,"data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22200%22%20height%3D%22200%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22%23FF9800%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20dominant-baseline%3D%22central%22%20text-anchor%3D%22middle%22%20font-size%3D%2216%22%20fill%3D%22white%22%3EProducto%203%3C%2Ftext%3E%3C%2Fsvg%3E"`;

    const blob = new Blob([template], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'plantilla_productos.csv';
    link.click();
}

async function importCsvData() {
    if (!csvData || csvData.length === 0) {
        alert('No hay datos para importar');
        return;
    }

    const confirmMsg = `¬øEst√°s seguro de importar ${csvData.length} productos? Esta acci√≥n agregar√° todos los productos a tu cat√°logo.`;
    if (!confirm(confirmMsg)) {
        return;
    }

    importCsv.textContent = 'Importando...';
    importCsv.disabled = true;

    try {
        let importedCount = 0;
        let errorCount = 0;
        const errors = [];

        for (let i = 0; i < csvData.length; i++) {
            const row = csvData[i];
            
            try {
                // Mapear campos del CSV a campos del producto
                const name = row.nombre || row.name || '';
                const shortDesc = row.descripcion || row.description || row.desc || '';
                const price = parseFloat(row.precio || row.price || 0);
                const stock = parseInt(row.stock || row.cantidad || 0);
                const category = row.categoria || row.category || '';
                const discount = parseInt(row.descuento || row.discount || 0);
                const imageUrl = row.imagen_url || row.image_url || row.imagen || row.image || '';

                // Validar campos obligatorios
                if (!name.trim()) {
                    errors.push(`Fila ${i + 2}: Falta el nombre del producto`);
                    errorCount++;
                    continue;
                }

                if (isNaN(price) || price <= 0) {
                    errors.push(`Fila ${i + 2}: Precio inv√°lido (${row.precio || row.price})`);
                    errorCount++;
                    continue;
                }

                // Crear producto
                const productData = {
                    id: Date.now() + i,
                    name: name.trim(),
                    shortDesc: shortDesc.trim(),
                    price: price,
                    stock: stock || 0,
                    category: category.trim(),
                    discount: (discount > 0 && discount <= 100) ? discount : null,
                    images: imageUrl.trim() ? [imageUrl.trim()] : []
                };

                // Agregar categor√≠a si no existe
                if (category.trim() && !categories.includes(category.trim())) {
                    categories.push(category.trim());
                }

                products.push(productData);
                importedCount++;

            } catch (error) {
                errors.push(`Fila ${i + 2}: Error procesando producto - ${error.message}`);
                errorCount++;
            }
        }

        // Guardar en servidor
        await saveToServer();
        
        // Actualizar UI
        render();
        fillCategories();
        cancelCsvImport();

        // Mostrar resultado
        let message = `Importaci√≥n completada:\n‚úÖ ${importedCount} productos importados`;
        if (errorCount > 0) {
            message += `\n‚ùå ${errorCount} errores`;
            if (errors.length <= 5) {
                message += `\n\nErrores:\n${errors.join('\n')}`;
            } else {
                message += `\n\nPrimeros errores:\n${errors.slice(0, 5).join('\n')}\n... y ${errors.length - 5} m√°s`;
            }
        }
        
        alert(message);

    } catch (error) {
        console.error('Error importando CSV:', error);
        alert('Error durante la importaci√≥n. Por favor, int√©ntalo de nuevo.');
    } finally {
        importCsv.textContent = 'üì§ Importar Productos';
        importCsv.disabled = false;
    }
}

function cancelCsvImport() {
    csvData = [];
    csvPreview.style.display = 'none';
    importCsv.style.display = 'none';
    cancelImport.style.display = 'none';
    csvFileInput.value = '';
}

// Hacer las funciones globales para que puedan ser llamadas desde el HTML
window.handleImageError = handleImageError;
window.removeImage = removeImage;
window.edit = edit;
window.del = del;